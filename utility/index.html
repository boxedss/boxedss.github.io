<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paul Precision Metering - Premium Utility Management</title>
    <!-- Favicon: White Water Drop in Blue Square -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%232563eb'/%3E%3Cpath d='M12 22c5.5 0 10-4.5 10-10 0-5.5-10-10-10-10S2 6.5 2 12c0 5.5 4.5 10 10 10z' fill='white'/%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        @media print {
            body * { visibility: hidden; }
            #invoice-preview, #invoice-preview * { visibility: visible; }
            #invoice-preview { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root">
        <div class="flex flex-col justify-center items-center h-screen bg-slate-50">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-500 font-medium">Initialising Demo Environment...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- Demo Storage Workarounds ---
        const DB_KEYS = {
            BUILDINGS: 'pm_demo_buildings_v3', // Incremented version to ensure new schema loads
            READINGS: 'pm_demo_readings_v3'
        };

        const loadData = (key) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.warn("LocalStorage access denied, using in-memory session.");
                return [];
            }
        };

        const saveData = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.warn("Could not save to LocalStorage.");
            }
        };

        // --- Stable Icon Component ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            
            useEffect(() => {
                const renderIcon = () => {
                    if (window.lucide && iconRef.current) {
                        const normalizedName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                        iconRef.current.setAttribute('data-lucide', normalizedName);
                        
                        window.lucide.createIcons({
                            icons: window.lucide.icons,
                            attrs: {
                                width: size,
                                height: size,
                                class: className,
                                'stroke-width': 2
                            }
                        });
                        return true;
                    }
                    return false;
                };

                if (!renderIcon()) {
                    const timer = setInterval(() => {
                        if (renderIcon()) clearInterval(timer);
                    }, 50);
                    return () => clearInterval(timer);
                }
            }, [name, size, className]);

            return <i ref={iconRef} className={`inline-flex shrink-0 items-center justify-center ${className}`} style={{ width: size, height: size }}></i>;
        };

        // --- UI Components ---
        const Modal = ({ isOpen, onClose, title, children, size = "default" }) => {
            if (!isOpen) return null;
            const sizes = { default: "max-w-2xl", large: "max-w-4xl", small: "max-w-md" };
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 animate-in">
                    <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className={`relative bg-white rounded-3xl shadow-2xl w-full ${sizes[size]} max-h-[90vh] overflow-hidden flex flex-col`}>
                        <div className="shrink-0 bg-gradient-to-r from-blue-600 to-cyan-500 p-6 flex justify-between items-center text-white">
                            <h2 className="text-xl font-bold tracking-tight">{title}</h2>
                            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-xl transition-all">
                                <Icon name="X" size={20} />
                            </button>
                        </div>
                        <div className="p-6 flex-1 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const Button = ({ children, variant = "primary", icon, onClick, disabled, type = "button", className = "" }) => {
            const styles = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md",
                secondary: "bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 shadow-sm",
                danger: "bg-red-600 text-white hover:bg-red-700 shadow-md",
                ghost: "text-slate-500 hover:bg-slate-100"
            };
            return (
                <button
                    type={type} onClick={onClick} disabled={disabled}
                    className={`px-5 py-2.5 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${styles[variant]} ${className}`}
                >
                    {icon && <Icon name={icon} size={18} />}
                    {children}
                </button>
            );
        };

        // --- Main App ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [buildings, setBuildings] = useState([]);
            const [historyLog, setHistoryLog] = useState([]);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);

            // Dashboard State
            const [dashFilter, setDashFilter] = useState('all');

            // Modals
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isReadingModalOpen, setIsReadingModalOpen] = useState(false);
            const [isInvoiceModalOpen, setIsInvoiceModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);

            // Selections
            const [selectedBuilding, setSelectedBuilding] = useState(null);
            const [selectedUtility, setSelectedUtility] = useState(null);
            const [lastReading, setLastReading] = useState(null);
            const [invoiceData, setInvoiceData] = useState(null);

            // Settings
            const [includeVat, setIncludeVat] = useState(true);
            const [vatRate, setVatRate] = useState(13.5);

            // Form States
            const [newBuilding, setNewBuilding] = useState({
                name: '', address: '', tenantName: '', tenantEmail: '',
                hasWater: true, waterRate: 1.50, initialWater: '',
                hasElectricity: true, elecRate: 0.34, initialElec: '',
                hasGas: false, gasRate: 0.11, initialGas: '',
                hasWaste: false, wasteRate: 1.20, initialWaste: ''
            });
            const [currentReading, setCurrentReading] = useState('');

            useEffect(() => {
                const b = loadData(DB_KEYS.BUILDINGS);
                const r = loadData(DB_KEYS.READINGS);
                setBuildings(b);
                setHistoryLog(r);
                setLoading(false);
            }, []);

            const showToast = (message, type = "info") => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };

            // Calculate days since a date
            const getDaysSince = (dateString) => {
                if (!dateString) return null;
                const diffTime = Math.abs(new Date() - new Date(dateString));
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            };

            const handleAddBuilding = (e) => {
                e.preventDefault();
                const bId = Date.now().toString();
                // Initialize lastInvoiced object
                const building = { 
                    ...newBuilding, 
                    id: bId, 
                    createdAt: new Date().toISOString(),
                    lastInvoiced: { water: null, electricity: null, gas: null, waste: null }
                };
                const updatedBuildings = [building, ...buildings];
                
                let updatedReadings = [...historyLog];
                const utilities = [
                    { type: 'water', active: newBuilding.hasWater, val: newBuilding.initialWater, rate: newBuilding.waterRate },
                    { type: 'electricity', active: newBuilding.hasElectricity, val: newBuilding.initialElec, rate: newBuilding.elecRate },
                    { type: 'gas', active: newBuilding.hasGas, val: newBuilding.initialGas, rate: newBuilding.gasRate },
                    { type: 'waste', active: newBuilding.hasWaste, val: newBuilding.initialWaste, rate: newBuilding.wasteRate }
                ];

                utilities.forEach(u => {
                    if (u.active && u.val) {
                        updatedReadings.push({
                            id: Math.random().toString(),
                            buildingId: bId,
                            buildingName: newBuilding.name,
                            utility: u.type,
                            reading: parseFloat(u.val) || 0,
                            rate: parseFloat(u.rate) || 0,
                            usage: 0, cost: 0,
                            timestamp: new Date().toISOString()
                        });
                    }
                });

                setBuildings(updatedBuildings);
                setHistoryLog(updatedReadings);
                saveData(DB_KEYS.BUILDINGS, updatedBuildings);
                saveData(DB_KEYS.READINGS, updatedReadings);
                
                setIsAddModalOpen(false);
                setNewBuilding({
                    name: '', address: '', tenantName: '', tenantEmail: '',
                    hasWater: true, waterRate: 1.50, initialWater: '',
                    hasElectricity: true, elecRate: 0.34, initialElec: '',
                    hasGas: false, gasRate: 0.11, initialGas: '',
                    hasWaste: false, wasteRate: 1.20, initialWaste: ''
                });
                showToast("Unit registered in local demo storage", "success");
            };

            const handleAddReading = (e) => {
                e.preventDefault();
                const val = parseFloat(currentReading);
                const prev = lastReading ? lastReading.reading : 0;
                const usage = val - prev;
                
                if (isNaN(val)) {
                    showToast("Please enter a valid number", "error");
                    return;
                }
                if (usage < 0) {
                    showToast("New reading cannot be lower than the previous one", "error");
                    return;
                }

                const rate = parseFloat(selectedBuilding[`${selectedUtility}Rate`]) || 0;
                const newLog = {
                    id: Date.now().toString(),
                    buildingId: selectedBuilding.id,
                    buildingName: selectedBuilding.name,
                    utility: selectedUtility,
                    reading: val,
                    rate: rate,
                    usage,
                    cost: usage * rate,
                    timestamp: new Date().toISOString()
                };

                const updatedReadings = [newLog, ...historyLog];
                setHistoryLog(updatedReadings);
                saveData(DB_KEYS.READINGS, updatedReadings);
                
                setIsReadingModalOpen(false);
                showToast("Meter reading synchronised", "success");
            };

            const handlePrintInvoice = () => {
                // 1. Update the building's lastInvoiced date for this utility
                const updatedBuildings = buildings.map(b => {
                    if (b.id === invoiceData.buildingId) {
                        return {
                            ...b,
                            lastInvoiced: {
                                ...b.lastInvoiced,
                                [invoiceData.utility]: new Date().toISOString()
                            }
                        };
                    }
                    return b;
                });
                
                setBuildings(updatedBuildings);
                saveData(DB_KEYS.BUILDINGS, updatedBuildings);
                
                // 2. Print
                window.print();
                showToast("Invoice recorded and printed", "success");
            };

            const handleDeleteBuilding = () => {
                const updatedBuildings = buildings.filter(b => b.id !== selectedBuilding.id);
                const updatedReadings = historyLog.filter(r => r.buildingId !== selectedBuilding.id);
                setBuildings(updatedBuildings);
                setHistoryLog(updatedReadings);
                saveData(DB_KEYS.BUILDINGS, updatedBuildings);
                saveData(DB_KEYS.READINGS, updatedReadings);
                setIsEditModalOpen(false);
                showToast("Property removed from demo", "info");
            };

            const stats = useMemo(() => {
                // Filter logs based on dashboard filter if needed, but usually stats are global
                // Let's filter stats by the dashboard utility filter too for consistency
                let filteredLogs = historyLog;
                if (dashFilter !== 'all') {
                    filteredLogs = historyLog.filter(l => l.utility === dashFilter);
                }

                const cost = filteredLogs.reduce((acc, curr) => acc + (parseFloat(curr.cost) || 0), 0);
                const usage = filteredLogs.reduce((acc, curr) => acc + (parseFloat(curr.usage) || 0), 0);
                return { cost, usage, count: filteredLogs.length };
            }, [historyLog, dashFilter]);

            // Filter buildings for the invoicing status list
            const filteredBuildings = useMemo(() => {
                return buildings.filter(b => {
                    if (dashFilter === 'all') return true;
                    // Check if building has the selected utility
                    const propName = `has${dashFilter.charAt(0).toUpperCase() + dashFilter.slice(1)}`;
                    return b[propName] === true;
                });
            }, [buildings, dashFilter]);

            if (loading) return null;

            return (
                <div className="min-h-screen pb-28">
                    {toast && (
                        <div className={`fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-2xl text-white shadow-2xl flex items-center gap-3 animate-in ${toast.type === 'error' ? 'bg-red-600' : 'bg-slate-800'}`}>
                            <Icon name={toast.type === 'error' ? 'AlertCircle' : 'Check'} size={18} />
                            <span className="font-medium">{toast.message}</span>
                        </div>
                    )}
                    
                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-40 px-6 py-5 flex justify-between items-center backdrop-blur-md bg-white/90">
                        <div className="flex items-center gap-4">
                            <div className="w-11 h-11 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-100">
                                <Icon name="Droplet" size={24} className="fill-white" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight text-slate-800">Paul Precision Metering</h1>
                                <p className="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Demo Environment</p>
                            </div>
                        </div>
                        <Button icon="Plus" onClick={() => setIsAddModalOpen(true)}>Add Unit</Button>
                    </header>

                    <main className="max-w-6xl mx-auto p-6 space-y-8 animate-in">
                        {/* Tab Switcher */}
                        <div className="flex bg-slate-200/50 p-1.5 rounded-2xl w-fit mx-auto sm:mx-0 shadow-inner">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'LayoutDashboard' },
                                { id: 'buildings', label: 'Properties', icon: 'Building2' },
                                { id: 'history', label: 'History', icon: 'History' }
                            ].map(t => (
                                <button
                                    key={t.id}
                                    onClick={() => setActiveTab(t.id)}
                                    className={`flex items-center gap-2 px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider transition-all ${
                                        activeTab === t.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    <Icon name={t.icon} size={14} />
                                    {t.label}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-8">
                                {/* Dashboard Filters */}
                                <div className="flex flex-wrap gap-2 animate-in">
                                    {['all', 'water', 'electricity', 'gas', 'waste'].map(u => (
                                        <button
                                            key={u}
                                            onClick={() => setDashFilter(u)}
                                            className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider border transition-all ${
                                                dashFilter === u 
                                                ? 'bg-slate-800 text-white border-slate-800' 
                                                : 'bg-white text-slate-500 border-slate-200 hover:border-slate-300'
                                            }`}
                                        >
                                            {u}
                                        </button>
                                    ))}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in">
                                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-8 text-white shadow-xl shadow-blue-200 relative overflow-hidden group">
                                        <Icon name="Euro" size={80} className="absolute -bottom-4 -right-4 opacity-10 group-hover:scale-110 transition-transform" />
                                        <p className="text-blue-100 text-xs font-bold uppercase tracking-widest mb-2 text-white/70">Total Expenditure ({dashFilter})</p>
                                        <h3 className="text-4xl font-black">€{stats.cost.toFixed(2)}</h3>
                                        <div className="mt-6 flex items-center gap-2 text-[10px] font-bold bg-white/20 py-1.5 px-3 rounded-full w-fit">
                                            <Icon name="Activity" size={12} />
                                            <span>OFFLINE SESSION ACTIVE</span>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                                        <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Total Consumption</p>
                                        <h3 className="text-4xl font-black text-slate-800">{stats.usage.toFixed(1)} <span className="text-sm font-medium text-slate-400">units</span></h3>
                                        <div className="mt-6 h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div className="h-full bg-blue-500 rounded-full" style={{ width: '65%' }}></div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm flex flex-col justify-between">
                                        <div>
                                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Active Units</p>
                                            <h3 className="text-4xl font-black text-slate-800">{buildings.length}</h3>
                                        </div>
                                        <p className="text-xs text-slate-500 flex items-center gap-1 mt-4">
                                            <Icon name="CheckCircle" size={14} className="text-emerald-500" /> Demo Persistence Enabled
                                        </p>
                                    </div>
                                </div>

                                {/* Invoicing Status Section */}
                                <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden animate-in">
                                    <div className="px-8 py-6 border-b border-slate-100 bg-slate-50/50">
                                        <h2 className="text-lg font-black text-slate-800">Invoicing Status</h2>
                                    </div>
                                    <div className="divide-y divide-slate-100">
                                        {filteredBuildings.length === 0 ? (
                                            <div className="p-12 text-center text-slate-400 text-sm">No units found for this filter.</div>
                                        ) : (
                                            filteredBuildings.map(b => (
                                                <div key={b.id} className="p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4 hover:bg-slate-50 transition-colors">
                                                    <div>
                                                        <p className="font-bold text-slate-800">{b.name}</p>
                                                        <p className="text-xs text-slate-500">{b.address}</p>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {['water', 'electricity', 'gas', 'waste'].map(u => {
                                                            const hasUtil = b[`has${u.charAt(0).toUpperCase() + u.slice(1)}`];
                                                            if (!hasUtil || (dashFilter !== 'all' && dashFilter !== u)) return null;

                                                            const lastInv = b.lastInvoiced?.[u];
                                                            const days = lastInv ? getDaysSince(lastInv) : 999;
                                                            
                                                            let statusColor = "bg-red-500"; // Default > 31 or null
                                                            let statusText = "Overdue / Never";
                                                            
                                                            if (days < 25) {
                                                                statusColor = "bg-emerald-500";
                                                                statusText = `${days} days ago`;
                                                            } else if (days <= 31) {
                                                                statusColor = "bg-orange-500";
                                                                statusText = "Due Soon";
                                                            }

                                                            return (
                                                                <div key={u} className="flex items-center gap-2 bg-slate-100 rounded-full pl-2 pr-4 py-1.5 border border-slate-200">
                                                                    <div className={`w-3 h-3 rounded-full ${statusColor} shadow-sm`}></div>
                                                                    <div className="flex flex-col leading-none">
                                                                        <span className="text-[10px] font-bold uppercase text-slate-600">{u}</span>
                                                                        <span className="text-[9px] font-medium text-slate-400">{statusText}</span>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'buildings' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-in">
                                {buildings.length === 0 ? (
                                    <div className="col-span-full py-24 text-center bg-white rounded-[40px] border-2 border-dashed border-slate-200">
                                        <Icon name="Building2" size={64} className="mx-auto text-slate-200 mb-6" />
                                        <h3 className="text-xl font-bold text-slate-800 mb-2">Workspace Empty</h3>
                                        <p className="text-slate-500 mb-8">Register a property to begin utility monitoring.</p>
                                        <Button icon="Plus" onClick={() => setIsAddModalOpen(true)}>Register Property</Button>
                                    </div>
                                ) : (
                                    buildings.map(b => (
                                        <div key={b.id} className="bg-white rounded-[32px] border border-slate-200 p-8 shadow-sm hover:shadow-md transition-all group">
                                            <div className="flex justify-between items-start mb-8">
                                                <div className="space-y-1">
                                                    <h3 className="text-2xl font-black text-slate-800 group-hover:text-blue-600 transition-colors">{b.name}</h3>
                                                    <div className="flex items-center gap-4 text-xs font-bold text-slate-400 uppercase tracking-tighter">
                                                        <span className="flex items-center gap-1"><Icon name="MapPin" size={12} /> {b.address}</span>
                                                        <span className="flex items-center gap-1"><Icon name="User" size={12} /> {b.tenantName}</span>
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => { setSelectedBuilding(b); setNewBuilding(b); setIsEditModalOpen(true); }}
                                                    className="w-10 h-10 flex items-center justify-center hover:bg-slate-100 rounded-2xl transition-all"
                                                >
                                                    <Icon name="Settings" size={20} className="text-slate-300" />
                                                </button>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3">
                                                {['water', 'electricity', 'gas', 'waste'].map(u => b[`has${u.charAt(0).toUpperCase() + u.slice(1)}`] && (
                                                    <button 
                                                        key={u}
                                                        onClick={() => {
                                                            setSelectedBuilding(b);
                                                            setSelectedUtility(u);
                                                            const r = historyLog.filter(l => l.buildingId === b.id && l.utility === u);
                                                            setLastReading(r.length > 0 ? r[0] : null);
                                                            setCurrentReading('');
                                                            setIsReadingModalOpen(true);
                                                        }}
                                                        className="p-4 bg-slate-50 border border-slate-100 rounded-2xl text-left hover:border-blue-400 hover:bg-blue-50/50 transition-all group/btn"
                                                    >
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <Icon name={u === 'electricity' ? 'Zap' : (u === 'water' ? 'Droplets' : (u === 'gas' ? 'Flame' : 'Waves'))} size={14} className="text-blue-500" />
                                                            <span className="text-[10px] font-black uppercase text-slate-400 tracking-widest">{u}</span>
                                                        </div>
                                                        <div className="flex items-baseline gap-1">
                                                            <span className="text-xl font-black text-slate-800">€{parseFloat(b[`${u}Rate`]).toFixed(2)}</span>
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="bg-white rounded-[32px] border border-slate-200 shadow-sm overflow-hidden animate-in">
                                <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <h2 className="text-xl font-black text-slate-800">Record History</h2>
                                    <div className="flex items-center gap-3 text-xs font-black text-slate-500 bg-white border border-slate-200 px-4 py-2.5 rounded-2xl shadow-sm">
                                        <input type="checkbox" checked={includeVat} onChange={e => setIncludeVat(e.target.checked)} className="w-4 h-4 rounded text-blue-600" />
                                        <span>VAT @ {vatRate}%</span>
                                    </div>
                                </div>
                                <div className="divide-y divide-slate-100">
                                    {historyLog.length === 0 ? (
                                        <div className="py-24 text-center text-slate-400 font-medium">No readings recorded yet.</div>
                                    ) : (
                                        historyLog.map(l => (
                                            <div key={l.id} className="p-6 hover:bg-blue-50/30 cursor-pointer flex items-center justify-between transition-colors" onClick={() => {
                                                const b = buildings.find(x => x.id === l.buildingId);
                                                const sub = l.cost;
                                                const vat = includeVat ? (sub * vatRate / 100) : 0;
                                                
                                                // Calculate Days Since Last Reading
                                                const relatedLogs = historyLog
                                                    .filter(h => h.buildingId === l.buildingId && h.utility === l.utility)
                                                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                                                
                                                const currentIndex = relatedLogs.findIndex(r => r.id === l.id);
                                                const prevLog = relatedLogs[currentIndex + 1];
                                                
                                                let daysSince = 0;
                                                if (prevLog) {
                                                    const diffTime = Math.abs(new Date(l.timestamp) - new Date(prevLog.timestamp));
                                                    daysSince = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                                                }

                                                setInvoiceData({ 
                                                    ...l, 
                                                    building: b, 
                                                    vatRate: includeVat ? vatRate : 0, 
                                                    vatAmount: vat, 
                                                    total: sub + vat, 
                                                    date: new Date(l.timestamp),
                                                    daysSince: daysSince
                                                });
                                                setIsInvoiceModalOpen(true);
                                            }}>
                                                <div className="flex items-center gap-6">
                                                    <div className="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-500">
                                                        <Icon name={l.utility === 'electricity' ? 'Zap' : (l.utility === 'water' ? 'Droplets' : 'Flame')} size={24} />
                                                    </div>
                                                    <div>
                                                        <p className="font-extrabold text-slate-800">{l.buildingName}</p>
                                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{l.utility} • {l.usage.toFixed(1)} Units</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-2xl font-black text-slate-800">€{l.cost.toFixed(2)}</p>
                                                    <p className="text-[10px] font-black text-blue-500 uppercase">{new Date(l.timestamp).toLocaleDateString('en-GB')}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* App Footer */}
                        <div className="text-center pt-6 pb-2">
                            <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">Created by Dave Maher</p>
                        </div>
                    </main>

                    {/* Registration Modal */}
                    <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="Register New Unit" size="large">
                        <form onSubmit={handleAddBuilding} className="space-y-8">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Friendly Name</label>
                                    <input required className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none transition-all font-bold" value={newBuilding.name} onChange={e => setNewBuilding({...newBuilding, name: e.target.value})} placeholder="e.g. Suite 201" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Physical Address</label>
                                    <input required className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none transition-all font-bold" value={newBuilding.address} onChange={e => setNewBuilding({...newBuilding, address: e.target.value})} placeholder="St. Patrick's Street..." />
                                </div>
                            </div>
                            <div className="space-y-5">
                                <h4 className="text-xs font-black text-slate-800 uppercase tracking-widest border-b pb-3">Utility Provisioning</h4>
                                {['water', 'electricity', 'gas', 'waste'].map(u => {
                                    const Key = u.charAt(0).toUpperCase() + u.slice(1);
                                    return (
                                        <div key={u} className="flex items-center gap-6 bg-slate-50 p-5 rounded-[24px] border border-slate-200">
                                            <div className="flex items-center gap-4 min-w-[140px]">
                                                <input type="checkbox" className="w-6 h-6 rounded-lg border-2" checked={newBuilding[`has${Key}`]} onChange={e => setNewBuilding({...newBuilding, [`has${Key}`]: e.target.checked})} />
                                                <span className="text-sm font-black uppercase text-slate-700">{u}</span>
                                            </div>
                                            {newBuilding[`has${Key}`] && (
                                                <div className="flex-1 flex gap-4">
                                                    <input type="number" step="0.001" required className="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" placeholder="Rate (€)" value={newBuilding[`${u}Rate`]} onChange={e => setNewBuilding({...newBuilding, [`${u}Rate`]: e.target.value})} />
                                                    <input type="number" step="0.01" required className="flex-1 p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold" placeholder="Initial" value={newBuilding[`initial${Key}`]} onChange={e => setNewBuilding({...newBuilding, [`initial${Key}`]: e.target.value})} />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                            <Button type="submit" className="w-full py-4 text-lg" icon="Check">Save Unit Locally</Button>
                        </form>
                    </Modal>

                    {/* Meter Entry Modal */}
                    <Modal isOpen={isReadingModalOpen} onClose={() => setIsReadingModalOpen(false)} title="Log Meter Reading">
                        <form onSubmit={handleAddReading} className="space-y-8 text-center">
                            <div className="bg-blue-50 border-2 border-blue-100 p-6 rounded-[32px] space-y-2">
                                <p className="text-[10px] font-black text-blue-600 uppercase tracking-widest">Previous Record</p>
                                <p className="text-4xl font-black text-blue-800 font-mono">{(lastReading?.reading || 0).toFixed(2)}</p>
                            </div>
                            <div className="space-y-3">
                                <label className="text-sm font-black text-slate-800 uppercase tracking-widest">Current Reading</label>
                                <input required type="number" step="0.01" className="w-full p-6 text-5xl font-black text-center border-4 border-slate-100 rounded-[32px] focus:border-blue-500 outline-none font-mono" value={currentReading} onChange={e => setCurrentReading(e.target.value)} autoFocus />
                            </div>
                            <Button type="submit" className="w-full py-5 text-xl" icon="Save">Commit Entry</Button>
                        </form>
                    </Modal>

                    {/* Invoice Visualiser */}
                    <Modal isOpen={isInvoiceModalOpen} onClose={() => setIsInvoiceModalOpen(false)} title="Utility Invoice" size="large">
                        {invoiceData && (
                            <div className="space-y-8 animate-in">
                                <div id="invoice-preview" className="bg-white border border-slate-200 rounded-[40px] overflow-hidden shadow-2xl">
                                    <div className="bg-slate-900 text-white p-12 flex justify-between items-start relative overflow-hidden">
                                        <div>
                                            <h2 className="text-3xl font-black tracking-tighter mb-1">Paul Precision Metering</h2>
                                            <p className="text-slate-400 font-bold uppercase tracking-widest text-xs">Date: {invoiceData.date.toLocaleDateString('en-GB')}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">Ref No.</p>
                                            <p className="font-mono text-xl font-bold">#{invoiceData.id.toUpperCase().slice(-8)}</p>
                                        </div>
                                    </div>
                                    <div className="p-12 space-y-12">
                                        <div className="grid grid-cols-2 gap-12">
                                            <div>
                                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Billing Unit</p>
                                                <p className="text-2xl font-black text-slate-800">{invoiceData.building.name}</p>
                                                <p className="text-slate-500">{invoiceData.building.address}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Service</p>
                                                <p className="text-2xl font-black text-slate-800 capitalize">{invoiceData.utility}</p>
                                                <p className="text-slate-500">Rate: €{invoiceData.rate.toFixed(3)}</p>
                                                {invoiceData.daysSince > 0 ? (
                                                     <p className="text-blue-600 font-bold text-sm mt-1">{invoiceData.daysSince} days since last invoice</p>
                                                ) : (
                                                    <p className="text-slate-400 font-medium text-sm mt-1">Initial Invoice</p>
                                                )}
                                            </div>
                                        </div>
                                        <div className="bg-slate-50 rounded-[32px] p-8 grid grid-cols-3 gap-8 text-center border border-slate-100">
                                            <div><p className="text-[10px] font-bold text-slate-400 uppercase">Start</p><p className="text-2xl font-black">{(invoiceData.reading - invoiceData.usage).toFixed(2)}</p></div>
                                            <div><p className="text-[10px] font-bold text-blue-500 uppercase">End</p><p className="text-2xl font-black text-blue-600">{invoiceData.reading.toFixed(2)}</p></div>
                                            <div><p className="text-[10px] font-bold text-slate-400 uppercase">Total</p><p className="text-2xl font-black">{invoiceData.usage.toFixed(2)}</p></div>
                                        </div>
                                        <div className="space-y-4 border-t-2 pt-8">
                                            <div className="flex justify-between font-bold text-slate-500"><span>Subtotal (Excl. VAT)</span><span>€{invoiceData.cost.toFixed(2)}</span></div>
                                            {invoiceData.vatAmount > 0 && <div className="flex justify-between font-bold text-slate-500"><span>VAT @ {invoiceData.vatRate}%</span><span>€{invoiceData.vatAmount.toFixed(2)}</span></div>}
                                            <div className="flex justify-between items-center pt-8 border-t-2 border-slate-100 mt-6"><span className="text-2xl font-black text-slate-800">Total Due</span><span className="text-5xl font-black text-blue-600">€{invoiceData.total.toFixed(2)}</span></div>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 p-6 text-center text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">Created by Dave Maher</div>
                                </div>
                                <div className="flex gap-4">
                                    <Button variant="secondary" className="flex-1 py-4" icon="Share2" onClick={() => showToast("Feature simulated in demo", "info")}>Share Copy</Button>
                                    <Button icon="Printer" className="flex-1 py-4" onClick={handlePrintInvoice}>Print / PDF</Button>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* Quick Edit/Delete */}
                    <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title="Manage Unit">
                        <div className="space-y-6">
                            <p className="text-slate-600">Permanently remove this property and all associated history?</p>
                            <div className="flex gap-3">
                                <Button variant="secondary" onClick={() => setIsEditModalOpen(false)} className="flex-1">Keep</Button>
                                <Button variant="danger" onClick={handleDeleteBuilding} icon="Trash2" className="flex-1">Delete</Button>
                            </div>
                        </div>
                    </Modal>

                    {/* Bottom Nav */}
                    <nav className="fixed bottom-0 inset-x-0 bg-white/80 backdrop-blur-xl border-t p-4 z-40 sm:hidden">
                        <div className="flex justify-around">
                            {['dashboard', 'buildings', 'history'].map(id => (
                                <button key={id} onClick={() => setActiveTab(id)} className={`flex flex-col items-center gap-1 ${activeTab === id ? 'text-blue-600' : 'text-gray-400'}`}>
                                    <Icon name={id === 'dashboard' ? 'LayoutDashboard' : (id === 'buildings' ? 'Building2' : 'History')} size={24} />
                                    <span className="text-[10px] font-bold uppercase tracking-widest">{id}</span>
                                </button>
                            ))}
                        </div>
                    </nav>

                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-xl border border-slate-200 shadow-2xl rounded-full px-4 py-3 hidden sm:flex items-center gap-2 z-50">
                        {['dashboard', 'buildings', 'history'].map(id => (
                            <button key={id} onClick={() => setActiveTab(id)} className={`p-3 rounded-full transition-all ${activeTab === id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-100'}`}>
                                <Icon name={id === 'dashboard' ? 'LayoutDashboard' : (id === 'buildings' ? 'Building2' : 'History')} size={20} />
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
