<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paul Precision Metering</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation (Pinned to 7.23.6 to fix ES modules target error) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- Import Map for React, Lucide, and Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Configuration Placeholder - REPLACE WITH YOUR REAL FIREBASE CONFIG -->
    <script>
        // REPLACE THE VALUES BELOW WITH YOUR REAL FIREBASE CONFIGURATION
        window.__firebase_config = JSON.stringify({
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        });
        window.__app_id = "paul-precision-metering";
        window.__initial_auth_token = ""; // Optional custom token
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            where, 
            updateDoc, 
            deleteDoc, 
            doc, 
            serverTimestamp,
            getDocs,
            onSnapshot
        } from 'firebase/firestore';
        import { 
            Plus, 
            Droplets, 
            Zap, 
            FileText, 
            History, 
            Settings, 
            User as UserIcon,
            MapPin, 
            X,
            Printer,
            Edit2,
            Trash2,
            Flame,
            Waves,
            LayoutDashboard,
            TrendingUp,
            Euro
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(window.__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

        // --- Components ---

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center h-64">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full text-gray-500">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-4 flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-sm border border-gray-100 p-4 ${className}`}>
                {children}
            </div>
        );

        const StatCard = ({ title, value, subtext, icon: Icon, colorClass }) => (
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-start justify-between">
                <div>
                    <p className="text-sm text-gray-500 font-medium mb-1">{title}</p>
                    <h3 className="text-2xl font-bold text-gray-900">{value}</h3>
                    {subtext && <p className="text-xs text-gray-400 mt-1">{subtext}</p>}
                </div>
                <div className={`p-2 rounded-lg ${colorClass}`}>
                    <Icon size={20} />
                </div>
            </div>
        );

        // --- Main Application Component ---

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [buildings, setBuildings] = useState([]);
            const [loading, setLoading] = useState(true);
            
            // Modal States
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isReadingModalOpen, setIsReadingModalOpen] = useState(false);
            const [isInvoiceModalOpen, setIsInvoiceModalOpen] = useState(false);
            const [isEditModalOpen, setIsEditModalOpen] = useState(false);
            
            // Data States
            const [historyLog, setHistoryLog] = useState([]);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // Active Selection States
            const [selectedBuilding, setSelectedBuilding] = useState(null);
            const [selectedUtility, setSelectedUtility] = useState(null);
            const [lastReading, setLastReading] = useState(null);

            // Dashboard Filters
            const [dashFilterPeriod, setDashFilterPeriod] = useState('all'); // all, month, year
            const [dashFilterUtility, setDashFilterUtility] = useState('all');

            // Form States
            const [newBuilding, setNewBuilding] = useState({
                name: '',
                address: '',
                tenantName: '',
                tenantEmail: '',
                
                hasWater: true,
                waterRate: 1.50,
                initialWater: '', 
                
                hasElectricity: true,
                elecRate: 0.34,
                initialElec: '',

                hasGas: false,
                gasRate: 0.11,
                initialGas: '',

                hasWaste: false,
                wasteRate: 1.20,
                initialWaste: ''
            });

            const [currentReading, setCurrentReading] = useState('');
            const [customRate, setCustomRate] = useState('');
            
            // VAT States
            const [includeVat, setIncludeVat] = useState(true);
            const [vatRate, setVatRate] = useState(13.5);
            
            const [invoiceData, setInvoiceData] = useState(null);

            // --- Auth & Data Loading ---

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                        await signInWithCustomToken(auth, window.__initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Fetch Buildings
            useEffect(() => {
                if (!user) return;

                const q = query(
                    collection(db, 'artifacts', appId, 'users', user.uid, 'buildings')
                );

                const unsubscribe = onSnapshot(q, 
                    (snapshot) => {
                        const buildingsData = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        buildingsData.sort((a, b) => {
                                const timeA = a.createdAt?.seconds || 0;
                                const timeB = b.createdAt?.seconds || 0;
                                return timeB - timeA;
                        });
                        setBuildings(buildingsData);
                        setLoading(false);
                    },
                    (error) => {
                        console.error("Error fetching buildings:", error);
                        setLoading(false);
                    }
                );

                return () => unsubscribe();
            }, [user]);

            // Fetch Readings (Always fetch for dashboard stats)
            useEffect(() => {
                if (!user) return;

                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'readings'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const logs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    logs.sort((a, b) => {
                        const dateA = a.date?.toDate ? a.date.toDate() : (a.date ? new Date(a.date) : new Date(0));
                        const dateB = b.date?.toDate ? b.date.toDate() : (b.date ? new Date(b.date) : new Date(0));
                        return dateB - dateA;
                    });

                    setHistoryLog(logs);
                });

                return () => unsubscribe();
            }, [user]);


            // --- Computed Dashboard Stats ---

            const dashboardStats = useMemo(() => {
                let filteredLogs = [...historyLog];
                const now = new Date();
                
                // Time Filter
                if (dashFilterPeriod === 'month') {
                    filteredLogs = filteredLogs.filter(log => {
                        const d = log.date?.toDate ? log.date.toDate() : new Date(log.date);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                } else if (dashFilterPeriod === 'year') {
                    filteredLogs = filteredLogs.filter(log => {
                        const d = log.date?.toDate ? log.date.toDate() : new Date(log.date);
                        return d.getFullYear() === now.getFullYear();
                    });
                }

                // Utility Filter
                if (dashFilterUtility !== 'all') {
                    filteredLogs = filteredLogs.filter(log => log.utility === dashFilterUtility);
                }

                const totalUsage = filteredLogs.reduce((acc, log) => acc + (Number(log.usage) || 0), 0);
                const totalCost = filteredLogs.reduce((acc, log) => {
                    if (log.totalBill) return acc + Number(log.totalBill);
                    return acc + ((Number(log.usage) || 0) * (Number(log.rateSnap) || 0));
                }, 0);

                const utilityBreakdown = {
                    water: 0,
                    electricity: 0,
                    gas: 0,
                    waste: 0
                };

                filteredLogs.forEach(log => {
                    if (utilityBreakdown[log.utility] !== undefined) {
                        const cost = log.totalBill || ((Number(log.usage) || 0) * (Number(log.rateSnap) || 0));
                        utilityBreakdown[log.utility] += cost;
                    }
                });

                return {
                    totalUsage,
                    totalCost,
                    count: filteredLogs.length,
                    utilityBreakdown
                };
            }, [historyLog, dashFilterPeriod, dashFilterUtility]);


            // --- Actions ---

            const handleAddBuilding = async (e) => {
                e.preventDefault();
                if (!user || isSubmitting) return;

                setIsSubmitting(true);
                try {
                    const buildingRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'buildings'), {
                        ...newBuilding,
                        waterRate: Number(newBuilding.waterRate) || 0,
                        elecRate: Number(newBuilding.elecRate) || 0,
                        gasRate: Number(newBuilding.gasRate) || 0,
                        wasteRate: Number(newBuilding.wasteRate) || 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });

                    const readingsCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'readings');
                    
                    const createInitialReading = async (utility, value, rate) => {
                        if (value && value !== '') {
                            await addDoc(readingsCollection, {
                                buildingId: buildingRef.id,
                                buildingName: newBuilding.name,
                                utility: utility,
                                value: Number(value),
                                rateSnap: Number(rate) || 0,
                                date: serverTimestamp(),
                                previousValue: 0,
                                usage: 0,
                                cost: 0,
                                vatAmount: 0,
                                totalBill: 0,
                                isInitial: true 
                            });
                        }
                    };

                    if (newBuilding.hasWater) await createInitialReading('water', newBuilding.initialWater, newBuilding.waterRate);
                    if (newBuilding.hasElectricity) await createInitialReading('electricity', newBuilding.initialElec, newBuilding.elecRate);
                    if (newBuilding.hasGas) await createInitialReading('gas', newBuilding.initialGas, newBuilding.gasRate);
                    if (newBuilding.hasWaste) await createInitialReading('waste', newBuilding.initialWaste, newBuilding.wasteRate);

                    setIsAddModalOpen(false);
                    resetForm();
                } catch (error) {
                    console.error("Error adding building:", error);
                    alert("Error adding building. Please try again.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const resetForm = () => {
                setNewBuilding({
                    name: '',
                    address: '',
                    tenantName: '',
                    tenantEmail: '',
                    hasWater: true,
                    waterRate: 1.50,
                    initialWater: '',
                    hasElectricity: true,
                    elecRate: 0.34,
                    initialElec: '',
                    hasGas: false,
                    gasRate: 0.11,
                    initialGas: '',
                    hasWaste: false,
                    wasteRate: 1.20,
                    initialWaste: ''
                });
            };

            const handleUpdateBuilding = async (e) => {
                e.preventDefault();
                if (!user || !selectedBuilding || isSubmitting) return;

                setIsSubmitting(true);
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'buildings', selectedBuilding.id);
                    await updateDoc(docRef, {
                        ...newBuilding,
                        waterRate: Number(newBuilding.waterRate) || 0,
                        elecRate: Number(newBuilding.elecRate) || 0,
                        gasRate: Number(newBuilding.gasRate) || 0,
                        wasteRate: Number(newBuilding.wasteRate) || 0,
                        updatedAt: serverTimestamp()
                    });
                    setIsEditModalOpen(false);
                    setSelectedBuilding(null);
                } catch (error) {
                    console.error("Error updating building", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleDeleteBuilding = async (id) => {
                if (!confirm('Are you sure you want to delete this property? This action will also delete ALL associated readings and cannot be undone.')) return;
                if (isSubmitting) return;

                setIsSubmitting(true);
                try {
                    const readingsQuery = query(
                        collection(db, 'artifacts', appId, 'users', user.uid, 'readings'),
                        where('buildingId', '==', id)
                    );
                    
                    const snapshot = await getDocs(readingsQuery);
                    
                    const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);

                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'buildings', id));
                    
                    setIsEditModalOpen(false);
                    setSelectedBuilding(null);
                } catch (error) {
                    console.error("Error deleting building and data:", error);
                    alert("Failed to delete building completely. Please try again.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleDeleteReading = async (id) => {
                if (!confirm('Are you sure you want to delete this reading record?')) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'readings', id));
                } catch (error) {
                    console.error("Error deleting reading:", error);
                    alert("Failed to delete reading.");
                }
            };

            const openReadingModal = async (building, utility) => {
                setSelectedBuilding(building);
                setSelectedUtility(utility);
                setCurrentReading('');
                setLastReading(null);
                setIncludeVat(true); 
                setVatRate(13.5); 
                
                let defaultRate = 0;
                if (utility === 'water') defaultRate = building.waterRate;
                else if (utility === 'electricity') defaultRate = building.elecRate;
                else if (utility === 'gas') defaultRate = building.gasRate;
                else if (utility === 'waste') defaultRate = building.wasteRate;
                
                setCustomRate((Number(defaultRate) || 0).toString());
                setIsReadingModalOpen(true);

                try {
                    const relevantReadings = historyLog
                        .filter(r => r.buildingId === building.id && r.utility === utility);

                    if (relevantReadings.length > 0) {
                        setLastReading(relevantReadings[0]);
                    }
                } catch (error) {
                    console.error("Error fetching last reading:", error);
                }
            };

            const submitReading = async () => {
                if (!currentReading || !user || isSubmitting) return;
                
                setIsSubmitting(true);
                const readingValue = parseFloat(currentReading);

                if (lastReading && readingValue < lastReading.value) {
                    alert("New reading cannot be lower than the previous reading!");
                    setIsSubmitting(false);
                    return;
                }

                const usage = lastReading ? (readingValue - lastReading.value) : 0;
                
                let rateToCharge = parseFloat(customRate);
                if (!customRate || isNaN(rateToCharge)) {
                    if (selectedUtility === 'water') rateToCharge = selectedBuilding.waterRate;
                    else if (selectedUtility === 'electricity') rateToCharge = selectedBuilding.elecRate;
                    else if (selectedUtility === 'gas') rateToCharge = selectedBuilding.gasRate;
                    else if (selectedUtility === 'waste') rateToCharge = selectedBuilding.wasteRate;
                    
                    rateToCharge = Number(rateToCharge) || 0;
                }

                const subtotal = usage * rateToCharge;
                const vatAmount = includeVat ? subtotal * (vatRate / 100) : 0;
                const totalBill = subtotal + vatAmount;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'readings'), {
                        buildingId: selectedBuilding.id,
                        buildingName: selectedBuilding.name,
                        utility: selectedUtility,
                        value: readingValue,
                        rateSnap: rateToCharge,
                        date: serverTimestamp(),
                        previousValue: lastReading ? lastReading.value : 0,
                        usage: usage,
                        cost: subtotal,
                        vatRate: includeVat ? vatRate : 0,
                        vatAmount: vatAmount,
                        totalBill: totalBill,
                        isInitial: false
                    });
                    
                    setIsReadingModalOpen(false);
                    
                    if (!lastReading) {
                        alert(`Initial ${selectedUtility} reading saved! The NEXT reading will generate a bill based on usage.`);
                    } else {
                        setInvoiceData({
                            building: selectedBuilding,
                            utility: selectedUtility,
                            currentReading: readingValue,
                            previousReading: lastReading.value,
                            usage: usage,
                            rate: rateToCharge,
                            subtotal: subtotal,
                            vatAmount: vatAmount,
                            vatRate: includeVat ? vatRate : 0,
                            total: totalBill,
                            date: new Date()
                        });
                        setIsInvoiceModalOpen(true);
                    }

                } catch (error) {
                    console.error("Error submitting reading:", error);
                } finally {
                    setIsSubmitting(false);
                }
            };

            const openEditModal = (building) => {
                setSelectedBuilding(building);
                setNewBuilding({ 
                    ...building, 
                    initialWater: '', 
                    initialElec: '',
                    initialGas: '',
                    initialWaste: ''
                });
                setIsEditModalOpen(true);
            };

            // --- UI Sections ---

            if (loading) return <LoadingSpinner />;

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 font-sans pb-20">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-20">
                        <div className="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-blue-600 p-2 rounded-lg text-white">
                                    <FileText size={20} />
                                </div>
                                <h1 className="text-xl font-bold tracking-tight text-gray-900">Paul Precision Metering</h1>
                            </div>
                            <button 
                                onClick={() => {
                                    resetForm();
                                    setIsAddModalOpen(true);
                                }}
                                className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-md transition-all active:scale-95"
                            >
                                <Plus size={24} />
                            </button>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="max-w-3xl mx-auto p-4 space-y-6">
                        
                        {/* === DASHBOARD TAB === */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                
                                {/* Filter Bar */}
                                <div className="flex flex-wrap gap-2 items-center justify-between">
                                    <h2 className="text-lg font-bold text-gray-800">Overview</h2>
                                    <div className="flex gap-2 text-sm">
                                        <select 
                                            value={dashFilterPeriod}
                                            onChange={(e) => setDashFilterPeriod(e.target.value)}
                                            className="bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                        >
                                            <option value="all">All Time</option>
                                            <option value="year">This Year</option>
                                            <option value="month">This Month</option>
                                        </select>
                                        <select 
                                            value={dashFilterUtility}
                                            onChange={(e) => setDashFilterUtility(e.target.value)}
                                            className="bg-white border border-gray-200 rounded-lg px-3 py-2 text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                        >
                                            <option value="all">All Utilities</option>
                                            <option value="water">Water</option>
                                            <option value="electricity">Electricity</option>
                                            <option value="gas">Gas</option>
                                            <option value="waste">Waste</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Stats Cards */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <StatCard 
                                        title="Total Costs (Est.)" 
                                        value={dashboardStats.totalCost.toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })}
                                        subtext={`${dashboardStats.count} records`}
                                        icon={Euro}
                                        colorClass="bg-green-100 text-green-700"
                                    />
                                    <StatCard 
                                        title="Total Units Used" 
                                        value={dashboardStats.totalUsage.toFixed(1)}
                                        subtext="Across all meters"
                                        icon={TrendingUp}
                                        colorClass="bg-blue-100 text-blue-700"
                                    />
                                    <StatCard 
                                        title="Total Properties" 
                                        value={buildings.length}
                                        subtext="Active buildings"
                                        icon={LayoutDashboard}
                                        colorClass="bg-purple-100 text-purple-700"
                                    />
                                </div>

                                {/* Cost Breakdown */}
                                <Card>
                                    <h3 className="font-bold text-gray-800 mb-4">Cost Distribution</h3>
                                    <div className="space-y-3">
                                        {[
                                            { key: 'electricity', label: 'Electricity', color: 'bg-amber-500', text: 'text-amber-700' },
                                            { key: 'gas', label: 'Gas', color: 'bg-orange-500', text: 'text-orange-700' },
                                            { key: 'water', label: 'Water', color: 'bg-blue-500', text: 'text-blue-700' },
                                            { key: 'waste', label: 'Waste', color: 'bg-indigo-500', text: 'text-indigo-700' },
                                        ].map((u) => {
                                            const val = dashboardStats.utilityBreakdown[u.key];
                                            const max = dashboardStats.totalCost || 1;
                                            const percent = (val / max) * 100;
                                            
                                            return (
                                                <div key={u.key}>
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="font-medium text-gray-600">{u.label}</span>
                                                        <span className="font-bold text-gray-900">
                                                            {val.toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })}
                                                        </span>
                                                    </div>
                                                    <div className="w-full bg-gray-100 rounded-full h-2">
                                                        <div 
                                                            className={`${u.color} h-2 rounded-full transition-all duration-500`} 
                                                            style={{ width: `${percent}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </Card>

                                {/* Recent Activity Preview */}
                                <div className="flex justify-between items-center mt-4">
                                    <h3 className="font-bold text-gray-800">Recent Activity</h3>
                                    <button 
                                        onClick={() => setActiveTab('history')}
                                        className="text-blue-600 text-sm font-medium hover:underline"
                                    >
                                        View Full History
                                    </button>
                                </div>
                                <div className="space-y-3">
                                    {historyLog.slice(0, 3).map(log => (
                                        <div key={log.id} className="bg-white p-3 rounded-lg border border-gray-100 flex justify-between items-center">
                                            <div>
                                                <p className="font-bold text-sm text-gray-800">{log.buildingName}</p>
                                                <p className="text-xs text-gray-500 capitalize">{log.utility} • {log.usage.toFixed(1)} units</p>
                                            </div>
                                            <p className="font-bold text-sm text-gray-700">
                                                {log.totalBill ? (
                                                    Number(log.totalBill).toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })
                                                ) : (
                                                    ((log.usage || 0) * (log.rateSnap || 0)).toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })
                                                )}
                                            </p>
                                        </div>
                                    ))}
                                    {historyLog.length === 0 && <p className="text-gray-400 text-center text-sm py-4">No recent activity</p>}
                                </div>
                            </div>
                        )}

                        {/* === BUILDINGS TAB === */}
                        {activeTab === 'buildings' && (
                            <div className="animate-in fade-in duration-300">
                                {/* Empty State */}
                                {buildings.length === 0 && (
                                    <div className="text-center py-12 px-4">
                                        <button 
                                            onClick={() => setIsAddModalOpen(true)}
                                            className="bg-blue-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6 hover:bg-blue-100 transition-colors cursor-pointer"
                                        >
                                            <Plus size={40} className="text-blue-500" />
                                        </button>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">No Properties Yet</h3>
                                        <p className="text-gray-500 mb-6">Add your first building to start tracking utility usage.</p>
                                        <button 
                                            onClick={() => setIsAddModalOpen(true)}
                                            className="bg-blue-600 text-white px-6 py-3 rounded-xl font-medium shadow-lg shadow-blue-200"
                                        >
                                            Add Property
                                        </button>
                                    </div>
                                )}

                                <div className="grid gap-4">
                                    {buildings.map(building => (
                                        <Card key={building.id} className="group hover:shadow-md transition-shadow">
                                            {/* Card Header */}
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="text-lg font-bold text-gray-900">{building.name}</h3>
                                                    <div className="flex items-center gap-1 text-gray-500 text-sm mt-1">
                                                        <UserIcon size={14} />
                                                        <span>{building.tenantName || 'No Tenant'}</span>
                                                    </div>
                                                    {building.address && (
                                                        <div className="flex items-center gap-1 text-gray-400 text-xs mt-1">
                                                            <MapPin size={12} />
                                                            <span className="truncate max-w-[200px]">{building.address}</span>
                                                        </div>
                                                    )}
                                                </div>
                                                <button 
                                                    onClick={() => openEditModal(building)}
                                                    className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                >
                                                    <Edit2 size={18} />
                                                </button>
                                            </div>

                                            {/* Utility Actions Grid */}
                                            <div className="grid grid-cols-2 gap-3">
                                                {/* Water */}
                                                {building.hasWater ? (
                                                    <button 
                                                        onClick={() => openReadingModal(building, 'water')}
                                                        className="flex flex-col items-center justify-center p-3 rounded-lg border border-blue-100 bg-blue-50 text-blue-700 active:bg-blue-100 transition-colors"
                                                    >
                                                        <Droplets size={24} className="mb-1" />
                                                        <span className="text-sm font-semibold">Water</span>
                                                    </button>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center p-3 rounded-lg border border-dashed border-gray-200 text-gray-300">
                                                        <Droplets size={24} className="mb-1 opacity-20" />
                                                        <span className="text-xs">N/A</span>
                                                    </div>
                                                )}

                                                {/* Electricity */}
                                                {building.hasElectricity ? (
                                                    <button 
                                                        onClick={() => openReadingModal(building, 'electricity')}
                                                        className="flex flex-col items-center justify-center p-3 rounded-lg border border-amber-100 bg-amber-50 text-amber-700 active:bg-amber-100 transition-colors"
                                                    >
                                                        <Zap size={24} className="mb-1" />
                                                        <span className="text-sm font-semibold">Electric</span>
                                                    </button>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center p-3 rounded-lg border border-dashed border-gray-200 text-gray-300">
                                                        <Zap size={24} className="mb-1 opacity-20" />
                                                        <span className="text-xs">N/A</span>
                                                    </div>
                                                )}

                                                {/* Gas */}
                                                {building.hasGas ? (
                                                    <button 
                                                        onClick={() => openReadingModal(building, 'gas')}
                                                        className="flex flex-col items-center justify-center p-3 rounded-lg border border-orange-100 bg-orange-50 text-orange-600 active:bg-orange-100 transition-colors"
                                                    >
                                                        <Flame size={24} className="mb-1" />
                                                        <span className="text-sm font-semibold">Gas</span>
                                                    </button>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center p-3 rounded-lg border border-dashed border-gray-200 text-gray-300">
                                                        <Flame size={24} className="mb-1 opacity-20" />
                                                        <span className="text-xs">N/A</span>
                                                    </div>
                                                )}

                                                {/* Waste Water */}
                                                {building.hasWaste ? (
                                                    <button 
                                                        onClick={() => openReadingModal(building, 'waste')}
                                                        className="flex flex-col items-center justify-center p-3 rounded-lg border border-indigo-100 bg-indigo-50 text-indigo-600 active:bg-indigo-100 transition-colors"
                                                    >
                                                        <Waves size={24} className="mb-1" />
                                                        <span className="text-sm font-semibold">Waste</span>
                                                    </button>
                                                ) : (
                                                    <div className="flex flex-col items-center justify-center p-3 rounded-lg border border-dashed border-gray-200 text-gray-300">
                                                        <Waves size={24} className="mb-1 opacity-20" />
                                                        <span className="text-xs">N/A</span>
                                                    </div>
                                                )}
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* === HISTORY TAB === */}
                        {activeTab === 'history' && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                                <h2 className="text-lg font-bold text-gray-800 mb-4">Reading History</h2>
                                {historyLog.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">No history found.</p>
                                ) : (
                                    historyLog.map(log => (
                                        <div key={log.id} className="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-sm text-gray-800">{log.buildingName}</span>
                                                    <span className={`text-xs px-2 py-0.5 rounded-full capitalize 
                                                        ${log.utility === 'water' ? 'bg-blue-100 text-blue-700' : 
                                                            log.utility === 'electricity' ? 'bg-amber-100 text-amber-700' :
                                                            log.utility === 'gas' ? 'bg-orange-100 text-orange-700' :
                                                            'bg-indigo-100 text-indigo-700'
                                                        }`}>
                                                        {log.utility}
                                                    </span>
                                                    {log.isInitial && (
                                                        <span className="text-[10px] uppercase font-bold tracking-wider bg-gray-100 text-gray-500 px-1 rounded">Initial</span>
                                                    )}
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1">
                                                    {log.date?.toDate ? log.date.toDate().toLocaleDateString() : 'Unknown Date'}
                                                </div>
                                                <div className="text-xs font-mono mt-1 text-gray-600">
                                                    Reading: {log.value} | Rate: €{Number(log.rateSnap || 0).toFixed(2)}
                                                    {log.vatAmount > 0 && <span className="text-gray-400 ml-1">(inc. VAT)</span>}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-gray-900">
                                                    {log.totalBill ? (
                                                        Number(log.totalBill).toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })
                                                    ) : (
                                                        ((log.usage || 0) * (log.rateSnap || 0)).toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })
                                                    )}
                                                </span>
                                                <button 
                                                    onClick={() => handleDeleteReading(log.id)}
                                                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        <div className="text-center text-xs text-gray-400 mt-8 mb-4">Created by Dave Maher</div>
                    </main>

                    {/* --- Modals --- */}
                    
                    {/* Reading Modal */}
                    <Modal 
                        isOpen={isReadingModalOpen} 
                        onClose={() => setIsReadingModalOpen(false)} 
                        title={`New ${selectedUtility ? selectedUtility.charAt(0).toUpperCase() + selectedUtility.slice(1) : ''} Reading`}
                    >
                        <div className="space-y-4">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                <h3 className="font-bold text-gray-800">{selectedBuilding?.name}</h3>
                                <p className="text-sm text-gray-500">
                                    Previous Reading: {lastReading ? lastReading.value : 'None (0)'}
                                </p>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Current Reading</label>
                                <input 
                                    type="number" 
                                    autoFocus
                                    className="w-full p-4 text-2xl font-mono border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    placeholder="00000.00"
                                    value={currentReading}
                                    onChange={e => setCurrentReading(e.target.value)}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Rate (per unit)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-3 text-gray-500">€</span>
                                    <input 
                                        type="number" 
                                        step="0.01"
                                        className="w-full p-3 pl-8 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                        value={customRate}
                                        onChange={e => setCustomRate(e.target.value)}
                                    />
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded-lg">
                                <div className="flex items-center justify-between">
                                    <label className="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={includeVat}
                                            onChange={(e) => setIncludeVat(e.target.checked)}
                                            className="rounded text-blue-600 focus:ring-blue-500"
                                        />
                                        Include VAT in Total?
                                    </label>
                                    {includeVat && (
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-gray-500">Rate %</span>
                                            <input 
                                                type="number" 
                                                value={vatRate}
                                                onChange={(e) => setVatRate(parseFloat(e.target.value) || 0)}
                                                className="w-16 p-1 text-sm border rounded text-right"
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>

                            <button 
                                onClick={submitReading}
                                disabled={!currentReading || isSubmitting}
                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 disabled:opacity-70 flex justify-center items-center"
                            >
                                {isSubmitting ? (
                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                ) : (
                                    "Submit Reading"
                                )}
                            </button>
                        </div>
                    </Modal>

                    {/* Add/Edit Building Modal */}
                    <Modal 
                        isOpen={isAddModalOpen || isEditModalOpen} 
                        onClose={() => {
                            setIsAddModalOpen(false);
                            setIsEditModalOpen(false);
                            resetForm();
                        }} 
                        title={isEditModalOpen ? "Edit Property Details" : "Add New Property"}
                    >
                        <form onSubmit={isEditModalOpen ? handleUpdateBuilding : handleAddBuilding} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Building/Unit Name</label>
                                <input 
                                    required
                                    type="text" 
                                    placeholder="e.g. Apt 4B, The Gables"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={newBuilding.name}
                                    onChange={e => setNewBuilding({...newBuilding, name: e.target.value})}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Tenant Name</label>
                                <input 
                                    type="text" 
                                    placeholder="e.g. John Doe"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={newBuilding.tenantName}
                                    onChange={e => setNewBuilding({...newBuilding, tenantName: e.target.value})}
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <input 
                                    type="text" 
                                    placeholder="Street Address"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={newBuilding.address}
                                    onChange={e => setNewBuilding({...newBuilding, address: e.target.value})}
                                />
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded-lg space-y-4 max-h-[300px] overflow-y-auto">
                                <h4 className="text-sm font-bold text-gray-900 uppercase tracking-wider sticky top-0 bg-gray-50 pb-2">Meters Configuration</h4>
                                
                                {/* Water Config */}
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={newBuilding.hasWater}
                                            onChange={e => setNewBuilding({...newBuilding, hasWater: e.target.checked})}
                                            className="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="font-medium text-gray-700 flex items-center gap-2">
                                            <Droplets size={16} className="text-blue-500" /> Water Meter
                                        </span>
                                    </label>
                                    
                                    {newBuilding.hasWater && (
                                        <div className="pl-7 grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Rate per m³</label>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    className="w-full p-2 border border-gray-300 rounded bg-white"
                                                    value={newBuilding.waterRate}
                                                    onChange={e => setNewBuilding({...newBuilding, waterRate: e.target.value})}
                                                />
                                            </div>
                                            {!isEditModalOpen && (
                                                <div>
                                                    <label className="block text-xs text-gray-500 mb-1">Initial Reading</label>
                                                    <input 
                                                        type="number" 
                                                        placeholder="00000"
                                                        className="w-full p-2 border border-gray-300 rounded bg-white"
                                                        value={newBuilding.initialWater}
                                                        onChange={e => setNewBuilding({...newBuilding, initialWater: e.target.value})}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="border-t border-gray-200"></div>

                                {/* Elec Config */}
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={newBuilding.hasElectricity}
                                            onChange={e => setNewBuilding({...newBuilding, hasElectricity: e.target.checked})}
                                            className="w-5 h-5 rounded text-amber-600 focus:ring-amber-500"
                                        />
                                        <span className="font-medium text-gray-700 flex items-center gap-2">
                                            <Zap size={16} className="text-amber-500" /> Electric Meter
                                        </span>
                                    </label>
                                    
                                    {newBuilding.hasElectricity && (
                                        <div className="pl-7 grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Rate per kWh</label>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    className="w-full p-2 border border-gray-300 rounded bg-white"
                                                    value={newBuilding.elecRate}
                                                    onChange={e => setNewBuilding({...newBuilding, elecRate: e.target.value})}
                                                />
                                            </div>
                                            {!isEditModalOpen && (
                                                <div>
                                                    <label className="block text-xs text-gray-500 mb-1">Initial Reading</label>
                                                    <input 
                                                        type="number" 
                                                        placeholder="00000"
                                                        className="w-full p-2 border border-gray-300 rounded bg-white"
                                                        value={newBuilding.initialElec}
                                                        onChange={e => setNewBuilding({...newBuilding, initialElec: e.target.value})}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="border-t border-gray-200"></div>

                                {/* Gas Config */}
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={newBuilding.hasGas}
                                            onChange={e => setNewBuilding({...newBuilding, hasGas: e.target.checked})}
                                            className="w-5 h-5 rounded text-orange-600 focus:ring-orange-500"
                                        />
                                        <span className="font-medium text-gray-700 flex items-center gap-2">
                                            <Flame size={16} className="text-orange-500" /> Gas Meter
                                        </span>
                                    </label>
                                    
                                    {newBuilding.hasGas && (
                                        <div className="pl-7 grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Rate per unit</label>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    className="w-full p-2 border border-gray-300 rounded bg-white"
                                                    value={newBuilding.gasRate}
                                                    onChange={e => setNewBuilding({...newBuilding, gasRate: e.target.value})}
                                                />
                                            </div>
                                            {!isEditModalOpen && (
                                                <div>
                                                    <label className="block text-xs text-gray-500 mb-1">Initial Reading</label>
                                                    <input 
                                                        type="number" 
                                                        placeholder="00000"
                                                        className="w-full p-2 border border-gray-300 rounded bg-white"
                                                        value={newBuilding.initialGas}
                                                        onChange={e => setNewBuilding({...newBuilding, initialGas: e.target.value})}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="border-t border-gray-200"></div>

                                {/* Waste Config */}
                                <div className="space-y-2">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={newBuilding.hasWaste}
                                            onChange={e => setNewBuilding({...newBuilding, hasWaste: e.target.checked})}
                                            className="w-5 h-5 rounded text-indigo-600 focus:ring-indigo-500"
                                        />
                                        <span className="font-medium text-gray-700 flex items-center gap-2">
                                            <Waves size={16} className="text-indigo-500" /> Waste Water
                                        </span>
                                    </label>
                                    
                                    {newBuilding.hasWaste && (
                                        <div className="pl-7 grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-xs text-gray-500 mb-1">Rate per unit</label>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    className="w-full p-2 border border-gray-300 rounded bg-white"
                                                    value={newBuilding.wasteRate}
                                                    onChange={e => setNewBuilding({...newBuilding, wasteRate: e.target.value})}
                                                />
                                            </div>
                                            {!isEditModalOpen && (
                                                <div>
                                                    <label className="block text-xs text-gray-500 mb-1">Initial Reading</label>
                                                    <input 
                                                        type="number" 
                                                        placeholder="00000"
                                                        className="w-full p-2 border border-gray-300 rounded bg-white"
                                                        value={newBuilding.initialWaste}
                                                        onChange={e => setNewBuilding({...newBuilding, initialWaste: e.target.value})}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>

                            </div>

                            <div className="pt-2 flex gap-3">
                                {isEditModalOpen && (
                                    <button 
                                        type="button"
                                        disabled={isSubmitting}
                                        onClick={() => handleDeleteBuilding(selectedBuilding.id)}
                                        className="flex-1 bg-red-50 text-red-600 py-3 rounded-lg font-medium hover:bg-red-100 transition-colors disabled:opacity-50"
                                    >
                                        Delete
                                    </button>
                                )}
                                <button 
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="flex-[2] bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 disabled:opacity-70 disabled:cursor-not-allowed flex justify-center items-center"
                                >
                                    {isSubmitting ? (
                                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    ) : (
                                        isEditModalOpen ? "Save Changes" : "Add Property"
                                    )}
                                </button>
                            </div>
                        </form>
                    </Modal>

                    {/* Invoice Modal */}
                    <Modal 
                        isOpen={isInvoiceModalOpen} 
                        onClose={() => setIsInvoiceModalOpen(false)} 
                        title="Invoice Generated"
                    >
                        {invoiceData && (
                            <div className="space-y-6">
                                <div id="invoice-preview" className="bg-white border p-6 rounded-lg shadow-sm overflow-hidden">
                                    {/* Invoice Header */}
                                    <div className="bg-blue-600 p-6 -mx-6 -mt-6 mb-6">
                                        <div className="flex justify-between items-start text-white">
                                            <div>
                                                <h2 className="text-2xl font-bold">Paul Precision Metering</h2>
                                                <p className="text-blue-100 text-sm mt-1">Utility Invoice</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-mono opacity-80">{invoiceData.date.toLocaleDateString()}</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-between items-start mb-6 border-b pb-4">
                                        <div className="text-right w-full">
                                            <h3 className="font-bold text-lg text-gray-900">{invoiceData.building.name}</h3>
                                            <p className="text-sm text-gray-600">{invoiceData.building.tenantName}</p>
                                            <p className="text-xs text-gray-400">{invoiceData.building.address}</p>
                                        </div>
                                    </div>

                                    <div className="space-y-4 mb-6">
                                        <div className="flex justify-between items-center py-2 border-b border-dashed">
                                            <span className="text-gray-600">Utility Type</span>
                                            <span className="font-bold capitalize">{invoiceData.utility}</span>
                                        </div>
                                        <div className="flex justify-between items-center py-2 border-b border-dashed">
                                            <span className="text-gray-600">Previous Reading</span>
                                            <span className="font-mono">{invoiceData.previousReading}</span>
                                        </div>
                                        <div className="flex justify-between items-center py-2 border-b border-dashed">
                                            <span className="text-gray-600">Current Reading</span>
                                            <span className="font-mono">{invoiceData.currentReading}</span>
                                        </div>
                                        <div className="flex justify-between items-center py-2 border-b border-dashed">
                                            <span className="text-gray-600">Usage</span>
                                            <span className="font-bold">{invoiceData.usage.toFixed(2)} units</span>
                                        </div>
                                        <div className="flex justify-between items-center py-2 border-b border-dashed">
                                            <span className="text-gray-600">Rate</span>
                                            <span className="font-mono">{invoiceData.rate.toFixed(2)} / unit</span>
                                        </div>
                                    </div>

                                    <div className="space-y-2 pt-2 border-t">
                                        <div className="flex justify-between items-center text-sm text-gray-600">
                                            <span>Subtotal</span>
                                            <span>{invoiceData.subtotal.toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })}</span>
                                        </div>
                                        {invoiceData.vatAmount > 0 && (
                                            <div className="flex justify-between items-center text-sm text-gray-600">
                                                <span>VAT ({invoiceData.vatRate}%)</span>
                                                <span>{invoiceData.vatAmount.toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })}</span>
                                            </div>
                                        )}
                                        <div className="flex justify-between items-center pt-2">
                                            <span className="text-xl font-bold text-gray-800">Total Due</span>
                                            <span className="text-2xl font-bold text-blue-600">
                                                {invoiceData.total.toLocaleString('en-IE', { style: 'currency', currency: 'EUR' })}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setIsInvoiceModalOpen(false)}
                                        className="flex-1 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors font-medium"
                                    >
                                        Close
                                    </button>
                                    <button 
                                        onClick={() => window.print()}
                                        className="flex-1 bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-900 transition-colors flex justify-center items-center gap-2"
                                    >
                                        <Printer size={18} /> Print Invoice
                                    </button>
                                </div>
                            </div>
                        )}
                    </Modal>

                    {/* Footer Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-3 flex justify-around items-center z-10">
                        <button 
                            onClick={() => setActiveTab('dashboard')}
                            className={`flex flex-col items-center ${activeTab === 'dashboard' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <LayoutDashboard size={24} />
                            <span className="text-xs mt-1">Dash</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('buildings')}
                            className={`flex flex-col items-center ${activeTab === 'buildings' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <Settings size={24} />
                            <span className="text-xs mt-1">Manage</span>
                        </button>
                        <button 
                            onClick={() => setActiveTab('history')}
                            className={`flex flex-col items-center ${activeTab === 'history' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <History size={24} />
                            <span className="text-xs mt-1">History</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
