<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxed Storage Simulator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        zinc: {
                            850: '#1f1f22',
                            900: '#18181b',
                            950: '#09090b',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #09090b; color: #fff; }
        
        /* Custom Scrollbar - Made slightly lighter/wider for better visibility */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #71717a; }
        
        /* Firefox Scrollbar */
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #52525b rgba(255,255,255,0.05); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .text-shadow-glow { text-shadow: 0 0 20px rgba(132, 204, 22, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS & STYLES ---
        const NOISE_SVG = `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E")`;
        const SPRING_EASE = "cubic-bezier(0.34, 1.56, 0.64, 1)";

        // --- COMPONENTS ---

        // Premium Button
        const PremiumButton = ({ children, onClick, active = false, variant = 'default', className = '', disabled = false }) => {
            const [xy, setXY] = useState({ x: 0, y: 0 });
            const btnRef = useRef(null);

            const handleMouseMove = (e) => {
                if (!btnRef.current) return;
                const rect = btnRef.current.getBoundingClientRect();
                setXY({ x: e.clientX - rect.left, y: e.clientY - rect.top });
            };

            const baseStyles = `relative overflow-hidden group rounded-xl transition-all duration-300 border outline-none select-none`;
            
            const variants = {
                default: `bg-zinc-900/40 border-zinc-800 hover:border-zinc-600 hover:bg-zinc-800/60 text-zinc-100 backdrop-blur-sm`,
                tab: `${active ? 'bg-lime-500 border-lime-400 text-zinc-950 shadow-[0_0_20px_rgba(132,204,22,0.4)] font-black' : 'bg-white border-zinc-200 text-zinc-600 hover:border-lime-500 hover:text-zinc-900 shadow-sm hover:shadow-md'}`,
                ghost: `bg-transparent border-transparent hover:bg-zinc-100/5 text-zinc-400 hover:text-zinc-200`,
                cta: `bg-lime-500 border-lime-400 text-zinc-950 font-black tracking-widest uppercase shadow-[0_4px_14px_0_rgba(132,204,22,0.39)] hover:shadow-[0_6px_20px_rgba(132,204,22,0.23)] hover:bg-lime-400`,
                glass: `bg-white/5 border-white/10 hover:bg-white/10 text-white backdrop-blur-sm`
            };

            const activeTransform = variant === 'tab' && active ? "scale-[1.02] -translate-y-[1px]" : "active:scale-[0.98] active:translate-y-[1px]";

            return (
                <button
                    ref={btnRef}
                    onClick={onClick}
                    onMouseMove={handleMouseMove}
                    disabled={disabled}
                    style={{ transitionTimingFunction: SPRING_EASE }}
                    className={`${baseStyles} ${variants[variant] || variants.default} ${activeTransform} ${className} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : 'cursor-pointer'}`}
                >
                    {!disabled && variant !== 'ghost' && variant !== 'tab' && (
                        <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none z-0" style={{ background: `radial-gradient(300px circle at ${xy.x}px ${xy.y}px, rgba(255,255,255,0.08), transparent 40%)` }} />
                    )}
                    <div className="absolute inset-0 z-0 opacity-20 pointer-events-none mix-blend-overlay" style={{ backgroundImage: NOISE_SVG }}></div>
                    <div className="relative z-10 flex items-center justify-center w-full h-full">{children}</div>
                </button>
            );
        };

        // Premium Card
        const PremiumCard = ({ children, className = '', contentClassName = '' }) => (
            <div className={`relative bg-zinc-900/80 backdrop-blur-xl border border-white/5 rounded-2xl shadow-2xl overflow-hidden ${className}`}>
                <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50"></div>
                <div className={`relative z-10 h-full ${contentClassName}`}>
                    {children}
                </div>
                <div className="absolute inset-0 z-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: NOISE_SVG }}></div>
            </div>
        );

        // --- CONSTANTS ---
        const CATEGORY_COLORS = { "Living Room": '#f97316', "Bedroom": '#3b82f6', "Dining & Kitchen": '#10b981', "Boxes & Misc": '#eab308' };
        
        const ROOM_CATEGORIES = {
            "Living Room": [
                { id: 'sofa_2', type: 'sofa', name: 'Sofa (2 Seater)', width: 1.5, depth: 0.9, height: 0.9 },
                { id: 'sofa_3', type: 'sofa', name: 'Sofa (3 Seater)', width: 2.1, depth: 0.9, height: 0.9 },
                { id: 'sofa_corner', type: 'sofa_corner', name: 'Corner Sofa', width: 2.2, depth: 2.2, height: 0.9 },
                { id: 'armchair', type: 'chair', name: 'Armchair', width: 0.9, depth: 0.9, height: 0.9 },
                { id: 'bean_bag', type: 'beanbag', name: 'Bean Bag', width: 0.8, depth: 0.8, height: 0.8 },
                { id: 'tv_unit', type: 'cabinet_tv', name: 'TV Unit', width: 1.2, depth: 0.4, height: 0.5 },
                { id: 'coffee_table', type: 'table', name: 'Coffee Table', width: 1.0, depth: 0.6, height: 0.4 },
                { id: 'bookcase', type: 'cabinet', name: 'Bookcase', width: 0.8, depth: 0.3, height: 1.8 },
                { id: 'rug', type: 'cylinder', name: 'Rug (Rolled)', width: 0.3, depth: 0.3, height: 2.0 },
            ],
            "Bedroom": [
                { id: 'bed_single', type: 'bed', name: 'Bed (Single)', width: 0.9, depth: 1.9, height: 0.6 },
                { id: 'bed_double', type: 'bed', name: 'Bed (Double)', width: 1.35, depth: 1.9, height: 0.6 },
                { id: 'bed_queen', type: 'bed', name: 'Bed (Queen)', width: 1.5, depth: 2.0, height: 0.6 }, 
                { id: 'bed_king', type: 'bed', name: 'Bed (King)', width: 1.5, depth: 2.0, height: 0.6 }, 
                { id: 'bed_super_king', type: 'bed', name: 'Bed (Super King)', width: 1.8, depth: 2.0, height: 0.6 },
                { id: 'wardrobe', type: 'wardrobe', name: 'Wardrobe', width: 1.0, depth: 0.6, height: 2.0 },
                { id: 'chest_drawers', type: 'cabinet', name: 'Chest of Drawers', width: 0.9, depth: 0.5, height: 0.9 },
                { id: 'bedside', type: 'cabinet', name: 'Bedside Table', width: 0.4, depth: 0.4, height: 0.5 },
                { id: 'cot', type: 'bed', name: 'Cot', width: 0.7, depth: 1.3, height: 0.9 },
            ],
            "Dining & Kitchen": [
                { id: 'dining_table', type: 'table', name: 'Dining Table', width: 1.6, depth: 0.9, height: 0.8 },
                { id: 'chair', type: 'chair_simple', name: 'Dining Chair', width: 0.5, depth: 0.5, height: 0.9 },
                { id: 'stool', type: 'cylinder_stool', name: 'Bar Stool', width: 0.4, depth: 0.4, height: 0.8 },
                { id: 'sideboard', type: 'cabinet', name: 'Sideboard', width: 1.5, depth: 0.5, height: 0.8 },
                { id: 'fridge', type: 'fridge', name: 'Fridge', width: 0.6, depth: 0.6, height: 1.7 },
                { id: 'washing_machine', type: 'washer', name: 'Washing Machine', width: 0.6, depth: 0.6, height: 0.85 },
                { id: 'tumble_dryer', type: 'washer', name: 'Tumble Dryer', width: 0.6, depth: 0.6, height: 0.85 },
                { id: 'dishwasher', type: 'washer', name: 'Dishwasher', width: 0.6, depth: 0.6, height: 0.85 },
                { id: 'microwave', type: 'box', name: 'Microwave', width: 0.5, depth: 0.4, height: 0.3 },
            ],
            "Boxes & Misc": [
                { id: 'box_m', type: 'box', name: 'Medium Box', width: 0.4, depth: 0.4, height: 0.4 },
                { id: 'box_l', type: 'box', name: 'Large Box', width: 0.5, depth: 0.5, height: 0.5 },
                { id: 'suitcase', type: 'box', name: 'Suitcase', width: 0.5, depth: 0.3, height: 0.7 },
                { id: 'bicycle', type: 'bike', name: 'Bicycle', width: 1.7, depth: 0.4, height: 1.0 },
                { id: 'golf_clubs', type: 'cylinder', name: 'Golf Clubs', width: 0.3, depth: 0.3, height: 1.2 },
                { id: 'lamp', type: 'cylinder', name: 'Floor Lamp', width: 0.3, depth: 0.3, height: 1.5 },
                { id: 'vacuum', type: 'cylinder', name: 'Vacuum Cleaner', width: 0.4, depth: 0.4, height: 1.2 },
                { id: 'ironing_board', type: 'box', name: 'Ironing Board', width: 0.4, depth: 0.1, height: 1.5 },
                { id: 'lawnmower', type: 'lawnmower', name: 'Lawnmower', width: 0.6, depth: 0.9, height: 0.5, warning: "Warning: Equipment with fuel tanks (like lawnmowers) must be fully drained and inspected before storage due to fire safety regulations." },
                { id: 'bbq', type: 'box', name: 'BBQ', width: 1.0, depth: 0.6, height: 1.0, warning: "Warning: Gas canisters must be removed and BBQs thoroughly cleaned of grease before storage." },
                { id: 'garden_chair', type: 'chair_simple', name: 'Garden Chair', width: 0.6, depth: 0.6, height: 0.9 },
            ]
        };

        const UNIT_TIERS = [
            { id: 'u25', name: '25 sq.ft (1 Bed Flat)', width: 1.5, depth: 1.5, height: 2.4, sqft: 25, price: 25 },
            { id: 'u50', name: '50 sq.ft (Transit Van)', width: 2.3, depth: 2.0, height: 2.4, sqft: 50, price: 45 },
            { id: 'u75', name: '75 sq.ft (Luton Van)', width: 2.7, depth: 2.6, height: 2.4, sqft: 75, price: 65 },
            { id: 'u100', name: '100 sq.ft (2-3 Bed)', width: 3.05, depth: 3.05, height: 2.4, sqft: 100, price: 85 },
            { id: 'u125', name: '125 sq.ft (3-4 Bed)', width: 3.5, depth: 3.3, height: 2.4, sqft: 125, price: 100 },
            { id: 'u150', name: '150 sq.ft (4+ Bed)', width: 3.8, depth: 3.7, height: 2.4, sqft: 150, price: 120 },
            { id: 'u200', name: '200 sq.ft (20ft Container)', width: 5.9, depth: 2.35, height: 2.4, sqft: 200, price: 150 },
            { id: 'u300', name: '300 sq.ft (40ft Container)', width: 12.0, depth: 2.35, height: 2.4, sqft: 300, price: 250 },
        ];

        const ICONS = {
            Plus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Minus: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Box: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            Truck: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>,
            Rotate: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>,
            Alert: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        };

        // --- LOGIC ---
        class Packer {
            constructor(w, d, h) {
                this.w = w; this.d = d; this.h = h;
                this.placedItems = [];
                this.spaces = [{ x: 0, y: 0, z: 0, w: w, d: d, h: h }];
            }
            placeItem(item) {
                for (let i = 0; i < this.spaces.length; i++) {
                    const s = this.spaces[i];
                    if (item.width <= s.w && item.depth <= s.d && item.height <= s.h) { this.finalizePlacement(item, s, i, false); return true; }
                    if (item.depth <= s.w && item.width <= s.d && item.height <= s.h) { this.finalizePlacement(item, s, i, true); return true; }
                }
                return false;
            }
            finalizePlacement(item, s, spaceIndex, rotated) {
                const w = rotated ? item.depth : item.width;
                const d = rotated ? item.width : item.depth;
                this.placedItems.push({ ...item, x: s.x, y: s.y, z: s.z, actualW: w, actualD: d, actualH: item.height, rotated: rotated });
                const newSpaces = [];
                if (s.w - w > 0) newSpaces.push({ x: s.x + w, y: s.y, z: s.z, w: s.w - w, d: s.d, h: s.h });
                if (s.d - d > 0) newSpaces.push({ x: s.x, y: s.y + d, z: s.z, w: w, d: s.d - d, h: s.h });
                if (s.h - item.height > 0) newSpaces.push({ x: s.x, y: s.y, z: s.z + item.height, w: w, d: d, h: s.h - item.height });
                this.spaces.splice(spaceIndex, 1);
                this.spaces.push(...newSpaces);
                this.spaces.sort((a, b) => a.z - b.z || a.y - b.y || a.x - b.x);
            }
        }

        const packIntoRooms = (inventory, availableTiers) => {
            let remainingItems = [...inventory].sort((a, b) => (b.width * b.depth * b.height) - (a.width * a.depth * a.height));
            const rooms = [];
            let loopCount = 0;
            while (remainingItems.length > 0 && loopCount < 10) {
                loopCount++;
                let selectedUnit = null;
                let bestPackResult = null;
                for (const tier of availableTiers) {
                    const packer = new Packer(tier.width, tier.depth, tier.height);
                    const failed = [];
                    remainingItems.forEach(item => { if (!packer.placeItem(item)) failed.push(item); });
                    if (failed.length === 0) { selectedUnit = tier; bestPackResult = { packed: packer.placedItems, failed: [] }; break; }
                }
                if (!selectedUnit) {
                    selectedUnit = availableTiers[availableTiers.length - 1]; 
                    const packer = new Packer(selectedUnit.width, selectedUnit.depth, selectedUnit.height);
                    const failed = [];
                    remainingItems.forEach(item => { if (!packer.placeItem(item)) failed.push(item); });
                    bestPackResult = { packed: packer.placedItems, failed };
                }
                rooms.push({ unit: selectedUnit, items: bestPackResult.packed });
                const packedIds = new Set(bestPackResult.packed.map(i => i.uid));
                remainingItems = remainingItems.filter(i => !packedIds.has(i.uid));
            }
            return rooms;
        };

        const ThreeCanvas = ({ items, unit }) => {
            const mountRef = useRef(null);
            const [engineState, setEngineState] = useState('loading');

            useEffect(() => {
                if (window.THREE) { setEngineState('ready'); return; }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
                script.async = true;
                script.onload = () => setEngineState('ready');
                document.body.appendChild(script);
            }, []);

            useEffect(() => {
                if (engineState !== 'ready' || !mountRef.current || mountRef.current.clientWidth === 0) return;
                let scene, camera, renderer, animFrame;
                const container = mountRef.current;
                
                // Helper to create geometries
                const createItemMesh = (THREE, item) => {
                    const group = new THREE.Group();
                    const w = item.width; const d = item.depth; const h = item.height;
                    const color = new THREE.Color(item.color);
                    const darkColor = color.clone().multiplyScalar(0.7);
                    const chromeColor = new THREE.Color(0xdddddd);
                    const blackColor = new THREE.Color(0x555555); 
                    const material = new THREE.MeshStandardMaterial({ color: color, roughness: 0.6 });
                    const darkMaterial = new THREE.MeshStandardMaterial({ color: darkColor, roughness: 0.8 });
                    const chromeMaterial = new THREE.MeshStandardMaterial({ color: chromeColor, roughness: 0.2, metalness: 0.8 });
                    const blackMaterial = new THREE.MeshStandardMaterial({ color: blackColor, roughness: 0.9 });
                    
                    const createBox = (bw, bh, bd, bx, by, bz, mat = material) => {
                        const geom = new THREE.BoxGeometry(bw, bh, bd);
                        const mesh = new THREE.Mesh(geom, mat);
                        mesh.position.set(bx, by, bz);
                        mesh.castShadow = true; mesh.receiveShadow = true;
                        return mesh;
                    };
                    const createCylinder = (rad, len, cx, cy, cz, rotationX = 0, rotationZ = 0, mat = material) => {
                        const geom = new THREE.CylinderGeometry(rad, rad, len, 16);
                        const mesh = new THREE.Mesh(geom, mat);
                        mesh.position.set(cx, cy, cz);
                        if(rotationX) mesh.rotation.x = rotationX;
                        if(rotationZ) mesh.rotation.z = rotationZ;
                        mesh.castShadow = true;
                        return mesh;
                    }

                    switch(item.type) {
                        case 'sofa_corner':
                            const thickness = Math.min(w, d) * 0.35; const seatH = h * 0.4; const backH = h * 0.6; const backThick = thickness * 0.3;
                            group.add(createBox(w, seatH, thickness, 0, seatH/2, -d/2 + thickness/2));
                            group.add(createBox(w, backH, backThick, 0, seatH + backH/2, -d/2 + backThick/2));
                            const lLength = d - thickness; 
                            group.add(createBox(thickness, seatH, lLength, -w/2 + thickness/2, seatH/2, -d/2 + thickness + lLength/2));
                            group.add(createBox(thickness, h*0.2, thickness*0.2, -w/2 + thickness/2, seatH + h*0.1, d/2 - thickness*0.1));
                            break;
                        case 'sofa':
                            group.add(createBox(w, h * 0.4, d, 0, h * 0.2, 0));
                            group.add(createBox(w, h * 0.6, d * 0.25, 0, h * 0.7, -d * 0.375));
                            group.add(createBox(w * 0.15, h * 0.4, d, -w * 0.425, h * 0.6, 0));
                            group.add(createBox(w * 0.15, h * 0.4, d, w * 0.425, h * 0.6, 0));
                            break;
                        case 'bed':
                            group.add(createBox(w, h * 0.3, d, 0, h * 0.15, 0, darkMaterial));
                            const mattressMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.9 });
                            group.add(createBox(w * 0.95, h * 0.2, d * 0.95, 0, h * 0.4, 0, mattressMat));
                            group.add(createBox(w, h * 0.5, d * 0.05, 0, h * 0.5, -d * 0.475, darkMaterial));
                            group.add(createBox(w * 0.4, h * 0.1, d * 0.15, 0, h * 0.55, -d * 0.35, mattressMat));
                            break;
                        case 'wardrobe':
                            group.add(createBox(w, h, d, 0, h/2, 0, material));
                            group.add(createBox(w*0.01, h*0.9, d*0.05, 0, h/2, d/2, darkMaterial));
                            group.add(createBox(w*0.05, h*0.1, d*0.05, -w*0.1, h*0.5, d/2+0.01, chromeMaterial));
                            group.add(createBox(w*0.05, h*0.1, d*0.05, w*0.1, h*0.5, d/2+0.01, chromeMaterial));
                            break;
                        case 'washer':
                            const wBody = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.2 });
                            group.add(createBox(w, h, d, 0, h/2, 0, wBody));
                            group.add(createBox(w, h*0.15, d*0.05, 0, h*0.9, d/2, wBody));
                            const doorRad = Math.min(w,h)*0.35;
                            group.add(createCylinder(doorRad, d*0.05, 0, h*0.5, d/2, Math.PI/2, 0, chromeMaterial));
                            const glassMat = new THREE.MeshStandardMaterial({ color: 0x88ccff, transparent: true, opacity: 0.6, roughness: 0 });
                            group.add(createCylinder(doorRad*0.8, d*0.06, 0, h*0.5, d/2, Math.PI/2, 0, glassMat));
                            break;
                        case 'fridge':
                            const fBody = new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.2 });
                            group.add(createBox(w, h, d, 0, h/2, 0, fBody));
                            group.add(createBox(w*0.95, h*0.01, d*0.05, 0, h*0.65, d/2, darkMaterial));
                            group.add(createBox(w*0.05, h*0.2, d*0.05, -w*0.4, h*0.8, d/2, chromeMaterial));
                            group.add(createBox(w*0.05, h*0.2, d*0.05, -w*0.4, h*0.5, d/2, chromeMaterial));
                            break;
                        case 'cabinet_tv':
                            group.add(createBox(w, h, d, 0, h/2, 0, material));
                            group.add(createBox(w*0.9, h*0.4, d*0.05, 0, h*0.6, d/2, blackMaterial));
                            group.add(createBox(w*0.4, h*0.3, d*0.02, -w*0.22, h*0.2, d/2, darkMaterial));
                            group.add(createBox(w*0.4, h*0.3, d*0.02, w*0.22, h*0.2, d/2, darkMaterial));
                            break;
                        case 'table':
                            group.add(createBox(w, h * 0.05, d, 0, h - (h*0.025), 0));
                            const legW = w * 0.1; const legD = d * 0.1; const legH = h * 0.95;
                            group.add(createBox(legW, legH, legD, -w/2 + legW, legH/2, -d/2 + legD));
                            group.add(createBox(legW, legH, legD, w/2 - legW, legH/2, -d/2 + legD));
                            group.add(createBox(legW, legH, legD, -w/2 + legW, legH/2, d/2 - legD));
                            group.add(createBox(legW, legH, legD, w/2 - legW, legH/2, d/2 - legD));
                            break;
                        case 'bike':
                            const wheelRad = h * 0.35;
                            group.add(createCylinder(wheelRad, w*0.02, -w*0.35, wheelRad, 0, Math.PI/2, 0, blackMaterial)); 
                            group.add(createCylinder(wheelRad, w*0.02, w*0.35, wheelRad, 0, Math.PI/2, 0, blackMaterial)); 
                            const frameThick = h * 0.05;
                            group.add(createBox(w*0.5, frameThick, frameThick, 0, h*0.5, 0, color)); 
                            group.add(createBox(frameThick, h*0.6, frameThick, 0, h*0.4, 0, color)); 
                            group.add(createBox(w*0.05, frameThick, d*0.6, w*0.3, h*0.8, 0, chromeMaterial));
                            break;
                        case 'lawnmower':
                            group.add(createBox(w, h*0.4, d, 0, h*0.2, 0, color));
                            group.add(createBox(w*0.6, h*0.3, d*0.6, 0, h*0.5, 0, blackMaterial));
                            const handleH = h;
                            group.add(createBox(w*0.05, h*0.8, d*0.05, -w*0.4, h*0.6, 0, chromeMaterial)); 
                            group.add(createBox(w*0.1, w*0.05, d*0.8, -w*0.5, h*0.9, 0, blackMaterial)); 
                            break;
                        case 'beanbag':
                            group.add(createCylinder(w*0.5, h*0.8, 0, h*0.4, 0, 0, 0, color));
                            break;
                        case 'chair': case 'chair_simple': case 'garden_chair':
                            group.add(createBox(w, h * 0.1, d, 0, h * 0.45, 0)); 
                            group.add(createBox(w, h * 0.5, d * 0.1, 0, h * 0.75, -d * 0.45)); 
                            const cLegW = w * 0.15;
                            group.add(createBox(cLegW, h * 0.4, cLegW, -w * 0.35, h * 0.2, -d * 0.35));
                            group.add(createBox(cLegW, h * 0.4, cLegW, w * 0.35, h * 0.2, -d * 0.35));
                            group.add(createBox(cLegW, h * 0.4, cLegW, -w * 0.35, h * 0.2, d * 0.35));
                            group.add(createBox(cLegW, h * 0.4, cLegW, w * 0.35, h * 0.2, d * 0.35));
                            break;
                        case 'box': default:
                            const boxMat = new THREE.MeshStandardMaterial({ color: item.type === 'box' ? 0xdcb386 : color, roughness: 0.8 });
                            group.add(createBox(w, h, d, 0, h/2, 0, boxMat));
                            if (item.type === 'box') {
                                const tape = createBox(w, h*0.01, d*0.99, 0, h, 0, new THREE.MeshBasicMaterial({color: 0xbd9266}));
                                group.add(tape);
                            } else {
                                const edges = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(w, h, d)), new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.2 }));
                                edges.position.set(0, h/2, 0); group.add(edges);
                            }
                            break;
                    }
                    return group;
                };

                try {
                    const THREE = window.THREE;
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    
                    if (width === 0 || height === 0) return; // Prevent 0-size crash

                    scene = new THREE.Scene();
                    scene.background = new THREE.Color(0x18181b); 

                    camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 100);
                    camera.position.set(unit.width * 2, unit.height * 2.5, unit.depth * 2);
                    camera.lookAt(unit.width / 2, unit.height / 2, unit.depth / 2);

                    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                    renderer.setSize(width, height);
                    renderer.shadowMap.enabled = true;
                    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    
                    while (container.firstChild) container.removeChild(container.firstChild);
                    container.appendChild(renderer.domElement);

                    // Light
                    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.7);
                    dirLight.position.set(5, 10, 5);
                    dirLight.castShadow = true;
                    scene.add(dirLight);

                    // Floor & Walls
                    const floor = new THREE.Mesh(new THREE.PlaneGeometry(unit.width, unit.depth), new THREE.MeshStandardMaterial({ color: 0x27272a }));
                    floor.rotation.x = -Math.PI / 2; floor.position.set(unit.width/2, 0, unit.depth/2); floor.receiveShadow = true; scene.add(floor);
                    const walls = new THREE.LineSegments(new THREE.EdgesGeometry(new THREE.BoxGeometry(unit.width, unit.height, unit.depth)), new THREE.LineBasicMaterial({ color: 0x84cc16 }));
                    walls.position.set(unit.width/2, unit.height/2, unit.depth/2); scene.add(walls);

                    // Items
                    items.forEach(item => {
                        const mesh = createItemMesh(THREE, item);
                        mesh.position.set(item.x + item.actualW/2, item.z, item.y + item.actualD/2);
                        if (item.rotated) mesh.rotation.y = Math.PI / 2;
                        scene.add(mesh);
                    });

                    // Cam Control
                    let theta = Math.PI/4, phi = Math.PI/3, r = Math.max(unit.width, unit.depth)*2.5;
                    let isDrag=false, last={x:0, y:0};
                    const updateCam = () => {
                        camera.position.set((unit.width/2) + r * Math.sin(phi) * Math.sin(theta), (unit.height/2) + r * Math.cos(phi), (unit.depth/2) + r * Math.sin(phi) * Math.cos(theta));
                        camera.lookAt(unit.width/2, unit.height/2, unit.depth/2);
                    };
                    updateCam();

                    const onDown = e => { isDrag=true; last={x:e.clientX, y:e.clientY}};
                    const onUp = () => isDrag=false;
                    const onMove = e => { if(isDrag) { theta -= (e.clientX - last.x)*0.01; phi -= (e.clientY - last.y)*0.01; phi = Math.max(0.1, Math.min(Math.PI/2-0.1, phi)); updateCam(); last={x:e.clientX, y:e.clientY}; }};
                    const onWheel = e => { e.preventDefault(); r = Math.max(2, Math.min(30, r + e.deltaY*0.01)); updateCam(); };

                    container.addEventListener('mousedown', onDown); window.addEventListener('mouseup', onUp); window.addEventListener('mousemove', onMove); container.addEventListener('wheel', onWheel, {passive:false});

                    // Resize Handling
                    const observer = new ResizeObserver(() => {
                        if(container.clientWidth > 0 && renderer && camera) {
                            camera.aspect = container.clientWidth / container.clientHeight;
                            camera.updateProjectionMatrix();
                            renderer.setSize(container.clientWidth, container.clientHeight);
                        }
                    });
                    observer.observe(container);

                    const animate = () => { animFrame = requestAnimationFrame(animate); renderer.render(scene, camera); };
                    animate();

                    return () => { cancelAnimationFrame(animFrame); observer.disconnect(); if(renderer) renderer.dispose(); };
                } catch (e) { setEngineState('error'); }
            }, [engineState, items, unit]);

            return (
                <div className="w-full h-full relative bg-zinc-900 rounded-xl overflow-hidden group shadow-[inset_0_2px_20px_rgba(0,0,0,0.5)] border border-white/5">
                    <div ref={mountRef} className="w-full h-full cursor-move" />
                    {/* MOVED SCROLL INDICATOR TO TOP-CENTER (BELOW TABS) */}
                    {engineState === 'ready' && <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 text-[10px] font-bold text-lime-400 flex items-center gap-2 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500 uppercase tracking-wider shadow-lg translate-y-2 group-hover:translate-y-0 ease-out z-20"><ICONS.Rotate /> Drag to Rotate • Scroll to Zoom</div>}
                    <div className="absolute inset-0 pointer-events-none bg-[radial-gradient(circle_at_center,transparent_50%,rgba(0,0,0,0.4)_100%)]"></div>
                </div>
            );
        };

        const App = () => {
            const [inventory, setInventory] = useState([]);
            const [activeTab, setActiveTab] = useState("Living Room");
            const [roomAllocations, setRoomAllocations] = useState([]);
            const [viewingRoomIndex, setViewingRoomIndex] = useState(0);
            const [vol, setVol] = useState(0);

            const addItem = (item, category) => { const color = CATEGORY_COLORS[category] || '#999'; setInventory([...inventory, { ...item, color, uid: Math.random() }]); };
            const removeOneItem = (itemId) => { const index = [...inventory].reverse().findIndex(i => i.id === itemId); if (index !== -1) { const newInv = [...inventory]; newInv.splice(newInv.length - 1 - index, 1); setInventory(newInv); } };
            const clearAll = () => setInventory([]);
            const itemCounts = useMemo(() => { const c = {}; inventory.forEach(i => c[i.id] = (c[i.id] || 0) + 1); return c; }, [inventory]);
            const uniqueItems = useMemo(() => { const u = []; const s = new Set(); inventory.forEach(i => { if (!s.has(i.id)) { s.add(i.id); u.push(i); } }); return u; }, [inventory]);
            const warnings = useMemo(() => { const s = new Set(); inventory.forEach(i => { if(i.warning) s.add(i.warning); }); return Array.from(s); }, [inventory]);

            useEffect(() => {
                setVol(inventory.reduce((acc, i) => acc + (i.width * i.depth * i.height), 0));
                const allocations = packIntoRooms(inventory, UNIT_TIERS);
                setRoomAllocations(allocations);
                if (viewingRoomIndex >= allocations.length) setViewingRoomIndex(0);
            }, [inventory]);

            const currentRoom = roomAllocations[viewingRoomIndex] || { unit: UNIT_TIERS[0], items: [] };

            return (
                <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans p-4 md:p-8 selection:bg-lime-500 selection:text-black">
                    <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-12">
                            <PremiumCard className="p-6">
                                <div className="flex flex-col sm:flex-row items-center justify-between gap-6">
                                    <div className="flex items-center gap-5">
                                        <div className="bg-lime-500 text-black p-4 rounded-xl font-bold shadow-[0_0_25px_rgba(132,204,22,0.4)]"><ICONS.Box /></div>
                                        <div>
                                            <h1 className="text-4xl font-black tracking-tighter text-white uppercase leading-none drop-shadow-xl">BO<span className="text-lime-500">[</span>X<span className="text-lime-500">]</span>ED<span className="text-lime-500">.</span></h1>
                                            <p className="text-xs text-zinc-400 font-bold uppercase tracking-[0.25em] mt-1.5 ml-0.5">Premium Storage Solution</p>
                                        </div>
                                    </div>
                                    <div className="text-right hidden sm:block">
                                        <div className="text-[10px] text-zinc-500 uppercase font-bold tracking-widest mb-1">Total Volume</div>
                                        <div className="font-mono text-3xl text-lime-400 font-bold tracking-tight text-shadow-glow">{vol.toFixed(2)} m³</div>
                                    </div>
                                </div>
                            </PremiumCard>
                        </div>

                        <div className="lg:col-span-4 space-y-6">
                            <PremiumCard className="p-1">
                                <div className="bg-white/95 p-5 rounded-xl text-zinc-900">
                                    <h2 className="text-sm font-black mb-5 flex items-center gap-2 uppercase tracking-wide text-zinc-900"><span className="text-lime-600 drop-shadow-sm"><ICONS.Plus /></span> Add Items</h2>
                                    <div className="grid grid-cols-2 gap-3 mb-5">
                                        {Object.keys(ROOM_CATEGORIES).map(cat => (
                                            <PremiumButton key={cat} onClick={() => setActiveTab(cat)} active={activeTab === cat} variant="tab" className="py-4 px-2">
                                                <span className="text-[10px] font-bold uppercase tracking-widest z-10 relative">{cat}</span>
                                            </PremiumButton>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 max-h-[450px] overflow-y-auto pr-1 custom-scrollbar pb-2">
                                        {ROOM_CATEGORIES[activeTab].map(item => {
                                            const count = itemCounts[item.id] || 0;
                                            return (
                                                <button key={item.id} onClick={() => addItem(item, activeTab)} className="group relative p-3 bg-zinc-50 border border-zinc-200 rounded-lg hover:border-lime-500 hover:bg-white text-left transition-all duration-200 shadow-sm hover:shadow-md active:scale-[0.98] overflow-hidden">
                                                    <div className="absolute top-0 left-0 w-1 h-full opacity-50 transition-all group-hover:opacity-100" style={{background: CATEGORY_COLORS[activeTab]}}></div>
                                                    <div className="flex justify-between items-start mb-2 pl-2">
                                                        <div className="w-1.5 h-1.5 rounded-full" style={{background: CATEGORY_COLORS[activeTab]}}></div>
                                                        {count > 0 && <span className="bg-lime-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">{count}</span>}
                                                    </div>
                                                    <div className="pl-2">
                                                        <div className="text-[11px] font-bold text-zinc-800 leading-tight mb-1 group-hover:text-black">{item.name}</div>
                                                        <div className="text-[9px] text-zinc-400 font-mono group-hover:text-zinc-500">{item.width}x{item.depth}m</div>
                                                    </div>
                                                    <div className="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 transition-all transform translate-y-2 group-hover:translate-y-0 duration-300">
                                                        <div className="w-5 h-5 bg-lime-500 text-white rounded-full flex items-center justify-center shadow-lg"><ICONS.Plus /></div>
                                                    </div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </PremiumCard>

                            <PremiumCard className="h-[350px] flex flex-col p-1">
                                <div className="bg-white/95 flex-1 p-5 rounded-xl flex flex-col min-h-0">
                                    <div className="flex justify-between items-center mb-4 border-b border-zinc-100 pb-3">
                                        <h3 className="text-sm font-bold flex items-center gap-2 uppercase tracking-wide text-zinc-900"><ICONS.Truck /> Your Items</h3>
                                        {inventory.length > 0 && <button onClick={clearAll} className="text-[10px] text-red-500 hover:text-red-600 flex items-center gap-1 font-bold uppercase transition-colors hover:bg-red-50 px-2 py-1 rounded-md"><ICONS.Trash /> Clear</button>}
                                    </div>
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar min-h-0">
                                        {inventory.length === 0 && <div className="h-full flex flex-col items-center justify-center text-zinc-300"><div className="p-4 bg-zinc-50 rounded-full mb-3"><ICONS.Box /></div><p className="text-[10px] font-bold tracking-widest uppercase text-zinc-400">Inventory Empty</p></div>}
                                        {uniqueItems.map(item => {
                                            const count = itemCounts[item.id];
                                            return (
                                                <div key={item.id} className="group flex justify-between items-center p-2.5 bg-zinc-50/80 rounded-lg border border-zinc-100 text-sm hover:border-zinc-300 hover:shadow-sm transition-all duration-200">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-2 h-2 rounded-full shadow-sm" style={{background: item.color}}></div>
                                                        <span className="truncate w-28 font-bold text-zinc-700 text-xs">{item.name}</span>
                                                    </div>
                                                    <div className="flex items-center bg-white border border-zinc-200 rounded-md shadow-sm overflow-hidden transform transition-transform group-hover:scale-105">
                                                        <button onClick={() => removeOneItem(item.id)} className="w-7 h-7 flex items-center justify-center hover:bg-zinc-50 text-zinc-400 hover:text-red-500 transition-colors"><ICONS.Minus /></button>
                                                        <span className="w-8 h-7 flex items-center justify-center text-[10px] font-bold text-zinc-900 border-x border-zinc-100 bg-zinc-50/50">{count}</span>
                                                        <button onClick={() => setInventory([...inventory, { ...item, uid: Math.random() }])} className="w-7 h-7 flex items-center justify-center hover:bg-zinc-50 text-lime-600 transition-colors"><ICONS.Plus /></button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    {warnings.length > 0 && <div className="mt-4 p-3 bg-amber-50/80 border border-amber-200 rounded-lg backdrop-blur-sm animate-pulse-slow">{warnings.map((msg, i) => <div key={i} className="flex items-start gap-2 text-[10px] text-amber-800 font-bold leading-tight mb-1 last:mb-0"><span className="text-amber-600 mt-0.5"><ICONS.Alert /></span>{msg}</div>)}</div>}
                                </div>
                            </PremiumCard>
                        </div>

                        <div className="lg:col-span-8 space-y-6">
                            <PremiumCard className="bg-black overflow-hidden group">
                                <div className="absolute inset-0 bg-gradient-to-r from-lime-900/20 to-transparent opacity-50"></div>
                                <div className="absolute top-0 right-0 w-[500px] h-[500px] bg-lime-500/10 rounded-full blur-[100px] transform translate-x-1/2 -translate-y-1/2 transition-opacity duration-700 opacity-20 group-hover:opacity-40"></div>
                                <div className="relative z-10 p-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-8">
                                    <div>
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-1.5 h-1.5 bg-lime-500 rounded-full animate-pulse"></div>
                                            <div className="text-lime-500 text-[10px] font-black uppercase tracking-[0.25em]">Recommended Solution</div>
                                        </div>
                                        {roomAllocations.length <= 1 ? (
                                            <>
                                                <h2 className="text-5xl font-black text-white italic tracking-tighter drop-shadow-lg transform transition-transform duration-500 group-hover:translate-x-1">{roomAllocations[0]?.unit.name.toUpperCase() || "EMPTY"}</h2>
                                                <p className="text-zinc-400 text-xs font-medium tracking-wide mt-2">Perfect fit for your inventory.</p>
                                            </>
                                        ) : (
                                            <>
                                                <h2 className="text-4xl font-black text-white italic tracking-tighter">MULTIPLE UNITS REQUIRED</h2>
                                                <div className="flex flex-wrap gap-2 mt-3">{roomAllocations.map((r, idx) => <span key={idx} className="bg-lime-500/10 border border-lime-500/30 text-lime-400 px-3 py-1.5 rounded-md text-[10px] font-bold uppercase tracking-wider backdrop-blur-md">Unit {idx+1}: {r.unit.name}</span>)}</div>
                                            </>
                                        )}
                                    </div>
                                    <div className="bg-white/5 backdrop-blur-md p-5 rounded-xl border border-white/10 min-w-[140px] text-center shadow-2xl group-hover:bg-white/10 transition-colors duration-300">
                                        <div className="text-4xl font-black text-white tracking-tight">€{roomAllocations.reduce((acc, r) => acc + r.unit.price, 0)}</div>
                                        <div className="text-[9px] uppercase text-zinc-400 font-bold tracking-widest mt-1">Total / Day (Ex VAT)</div>
                                    </div>
                                </div>
                            </PremiumCard>

                            <PremiumCard className="p-1 h-[600px] flex flex-col" contentClassName="flex flex-col">
                                {roomAllocations.length > 0 && (
                                    <div className="flex bg-black/40 p-1.5 gap-2 overflow-x-auto border-b border-white/5 backdrop-blur-md rounded-t-xl z-20 shrink-0">
                                        {roomAllocations.map((r, idx) => (
                                            <PremiumButton key={idx} onClick={() => setViewingRoomIndex(idx)} active={viewingRoomIndex === idx} variant={viewingRoomIndex === idx ? 'default' : 'glass'} className="flex-1 py-3">
                                                <div className="flex flex-col items-center">
                                                    <span className="text-[10px] font-black uppercase tracking-widest">Room {idx + 1}</span>
                                                    <span className={`text-[9px] font-medium mt-0.5 ${viewingRoomIndex === idx ? 'text-lime-500' : 'text-zinc-500'}`}>({r.unit.sqft} sq.ft)</span>
                                                </div>
                                            </PremiumButton>
                                        ))}
                                    </div>
                                )}
                                <div className="flex-1 relative overflow-hidden rounded-b-xl bg-zinc-900 w-full">
                                    <ThreeCanvas items={currentRoom.items} unit={currentRoom.unit} />
                                    <div className="absolute bottom-6 left-6 z-10 flex gap-2 pointer-events-none flex-wrap">
                                        {Object.entries(CATEGORY_COLORS).map(([cat, color]) => (
                                            <div key={cat} className="bg-black/60 backdrop-blur-xl px-3 py-1.5 rounded-full border border-white/10 flex items-center gap-2 shadow-lg">
                                                <div className="w-2 h-2 rounded-full shadow-[0_0_8px_rgba(255,255,255,0.5)]" style={{background: color}}></div>
                                                <span className="text-[9px] font-bold text-zinc-200 uppercase tracking-wider">{cat}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </PremiumCard>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <PremiumCard className="p-6 group hover:border-lime-500/30 transition-colors duration-500 cursor-pointer">
                                    <div className="absolute top-0 right-0 p-3 opacity-20 group-hover:opacity-100 transition-opacity duration-500"><div className="w-2 h-2 bg-lime-500 rounded-full shadow-[0_0_10px_#84cc16]"></div></div>
                                    <h4 className="font-bold text-white uppercase tracking-widest text-sm mb-3">Packaging Supplies</h4>
                                    <p className="text-xs text-zinc-400 mb-6 leading-relaxed">Need boxes? We stock heavy-duty double-walled boxes, bubble wrap, and tape.</p>
                                    <button onClick={() => window.open('https://boxedstorage.ie/shop/', '_blank')} className="inline-flex items-center gap-2 text-xs font-bold text-lime-500 uppercase tracking-widest group-hover:translate-x-2 transition-transform duration-300">View Shop <span>→</span></button>
                                </PremiumCard>
                                <PremiumButton variant="cta" className="h-full rounded-2xl" onClick={() => alert("Reservation flow would start here.")}>
                                    <div className="flex flex-col items-center gap-1 z-10 relative py-6">
                                        <span className="flex items-center gap-3 text-lg">Reserve {roomAllocations.length > 1 ? 'Units' : 'Unit'} <span className="opacity-50">→</span></span>
                                        <span className="text-[9px] text-zinc-900/60 font-bold uppercase tracking-widest">No credit card required</span>
                                    </div>
                                </PremiumButton>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
